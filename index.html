<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Footprint ‚Äî Growth Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0e0e14;
  --paper: #f5f2ed;
  --paper2: #ede9e1;
  --rule: #d9d3c8;
  --dev: #1a4d3e;
  --dev-light: #e8f4f0;
  --pm: #5c1a00;
  --pm-light: #fdf0e8;
  --gold: #c8973a;
  --gold-light: #fdf6e8;
  --red: #c0392b;
  --text: #1a1a24;
  --muted: #7a7065;
  --shadow: rgba(14,14,20,0.08);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--paper); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; }
body::before {
  content: ''; position: fixed; inset: 0; z-index: 0;
  background-image: repeating-linear-gradient(transparent, transparent 27px, rgba(180,160,130,0.15) 27px, rgba(180,160,130,0.15) 28px);
  pointer-events: none;
}
body::after {
  content: ''; position: fixed; top: 0; bottom: 0; left: 68px; z-index: 0;
  width: 1px; background: rgba(200,151,58,0.2); pointer-events: none;
}
.wrap { position: relative; z-index: 1; max-width: 1020px; margin: 0 auto; padding: 32px 24px 100px; }

/* HEADER */
.top-bar { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 32px; padding-bottom: 18px; border-bottom: 2px solid var(--ink); flex-wrap: wrap; gap: 14px; }
.logo { font-family: 'Playfair Display', serif; font-weight: 900; font-size: 38px; line-height: 1; letter-spacing: -1.5px; }
.logo em { font-style: italic; color: var(--dev); }
.logo-sub { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 3px; color: var(--muted); margin-top: 4px; }
.header-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
.current-date { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); }

/* SHEET SWITCHER */
.sheet-switcher { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
.sh-tab {
  display: flex; align-items: center; gap: 5px;
  font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.3px;
  padding: 5px 11px; border-radius: 4px; cursor: pointer;
  border: 1.5px solid var(--rule); background: #fff; color: var(--muted);
  transition: all 0.15s;
}
.sh-tab.active { color: var(--ink); border-color: var(--ink); background: var(--paper); font-weight: 600; }
.sh-tab:hover:not(.active) { border-color: var(--muted); color: var(--text); }
.sh-cdot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.sh-sdot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.sh-sdot.ok { background: #27ae60; } .sh-sdot.off { background: #ccc; }
.btn-add-sheet { font-family: 'DM Mono', monospace; font-size: 12px; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: 1.5px dashed var(--rule); background: transparent; color: var(--muted); transition: all 0.15s; }
.btn-add-sheet:hover { border-color: var(--dev); color: var(--dev); }
.btn-mgr { font-family: 'DM Mono', monospace; font-size: 10px; padding: 5px 9px; border-radius: 4px; cursor: pointer; border: 1.5px solid var(--rule); background: transparent; color: var(--muted); transition: all 0.15s; letter-spacing: 0.5px; }
.btn-mgr:hover { border-color: var(--gold); color: var(--gold); }

/* TABS */
.tabs { display: flex; gap: 0; margin-bottom: 26px; border-bottom: 2px solid var(--ink); }
.tab { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 14px; padding: 10px 22px 12px; cursor: pointer; border: none; background: transparent; color: var(--muted); border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
.tab.active { color: var(--ink); border-bottom-color: var(--ink); }
.tab:hover:not(.active) { color: var(--text); }

/* ACTIVE SHEET BAR */
.active-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding: 10px 16px; background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; font-size: 13px; }
.active-bar .sh-cdot { width: 10px; height: 10px; }
.ab-name { font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 500; }
.ab-info { font-size: 11px; color: var(--muted); font-family: 'DM Mono', monospace; margin-left: auto; }
.ab-status { display: flex; align-items: center; gap: 5px; font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); }

/* FORMS */
.log-card { background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; padding: 24px 28px; margin-bottom: 20px; box-shadow: 0 2px 10px var(--shadow); }
.section-label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 3px; color: var(--muted); text-transform: uppercase; margin-bottom: 16px; padding-bottom: 6px; border-bottom: 1px solid var(--rule); }
.frow { display: grid; gap: 14px; margin-bottom: 16px; }
.frow.c2 { grid-template-columns: 190px 1fr; }
.frow.c3 { grid-template-columns: 170px 1fr 150px; }
@media(max-width:640px){ .frow.c2,.frow.c3 { grid-template-columns: 1fr; } }
.field label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; display: block; margin-bottom: 6px; }
input[type=text],input[type=date],input[type=month],input[type=number],textarea,select {
  width: 100%; background: #fff; border: 1.5px solid var(--rule); color: var(--text);
  padding: 9px 13px; border-radius: 4px; font-family: 'DM Sans', sans-serif; font-size: 14px;
  outline: none; transition: border-color 0.2s; -webkit-appearance: none;
}
input:focus, textarea:focus, select:focus { border-color: var(--dev); }
textarea { resize: vertical; min-height: 80px; line-height: 1.6; }

/* Chips */
.cats-wrap { display: flex; gap: 7px; flex-wrap: wrap; }
.cat-chip { font-family: 'DM Mono', monospace; font-size: 11px; padding: 5px 13px; border-radius: 3px; cursor: pointer; user-select: none; border: 1.5px solid var(--rule); color: var(--muted); background: #fff; transition: all 0.15s; }
.cat-chip:hover { border-color: var(--dev); color: var(--dev); }
.cat-chip.sel-dev   { background: var(--dev);  color: #fff; border-color: var(--dev); }
.cat-chip.sel-pm    { background: var(--pm);   color: #fff; border-color: var(--pm); }
.cat-chip.sel-learn { background: var(--gold); color: #fff; border-color: var(--gold); }
.cat-chip.sel-other { background: var(--ink);  color: #fff; border-color: var(--ink); }

/* Buttons */
.btn { font-family: 'DM Mono', monospace; font-weight: 500; font-size: 11px; padding: 10px 22px; border-radius: 4px; cursor: pointer; border: 1.5px solid; letter-spacing: 1px; text-transform: uppercase; transition: all 0.18s; white-space: nowrap; }
.btn-primary { background: var(--ink); color: var(--paper); border-color: var(--ink); }
.btn-primary:hover { background: var(--dev); border-color: var(--dev); }
.btn-gold { background: var(--gold); color: #fff; border-color: var(--gold); }
.btn-gold:hover { opacity: 0.85; }
.btn-outline { background: transparent; color: var(--text); border-color: var(--rule); }
.btn-outline:hover { border-color: var(--text); }
.btn-danger { background: transparent; color: var(--red); border-color: #e9b4b4; }
.btn-danger:hover { background: #fdecea; }
.btn-sm { font-size: 10px; padding: 5px 10px; }
.btn-edit { background: transparent; color: var(--dev); border-color: #a8d8c8; font-size: 10px; padding: 5px 10px; }
.btn-row { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; align-items: center; }
.save-hint { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); }

/* FILTER BAR */
.filter-bar { background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; padding: 14px 18px; margin-bottom: 16px; display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
.filter-bar .field { flex: 1; min-width: 110px; }

/* DAY GROUPS */
.day-group { margin-bottom: 20px; }
.day-header { display: flex; align-items: center; gap: 10px; margin-bottom: 9px; padding-bottom: 7px; border-bottom: 1px solid var(--rule); }
.day-date-label { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 16px; }
.day-dow { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; }
.day-cat-pills { display: flex; gap: 4px; flex-wrap: wrap; margin-left: auto; }
.day-pill { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px; text-transform: uppercase; padding: 2px 8px; border-radius: 10px; }
.pill-dev { background: var(--dev-light); color: var(--dev); }
.pill-pm  { background: var(--pm-light);  color: var(--pm); }
.pill-learn { background: var(--gold-light); color: var(--gold); }
.pill-review,.pill-design,.pill-infra,.pill-collab,.pill-bug,.pill-meeting,.pill-other { background: var(--paper2); color: var(--muted); }
.day-hrs { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); }

/* ENTRY */
.entry { background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; padding: 14px 17px; margin-bottom: 6px; border-left: 4px solid var(--rule); transition: box-shadow 0.18s; animation: up 0.2s ease both; }
@keyframes up { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
.entry:hover { box-shadow: 0 3px 12px var(--shadow); }
.entry.t-dev   { border-left-color: var(--dev); }
.entry.t-pm    { border-left-color: var(--pm); }
.entry.t-learn { border-left-color: var(--gold); }
.entry-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
.entry-title { font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 700; margin-bottom: 3px; }
.entry-desc { font-size: 13px; color: var(--muted); line-height: 1.6; margin-bottom: 7px; }
.entry-chips { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
.chip { font-family: 'DM Mono', monospace; font-size: 9px; padding: 2px 7px; border-radius: 2px; letter-spacing: 0.5px; text-transform: uppercase; }
.chip-dev   { background: var(--dev-light); color: var(--dev); }
.chip-pm    { background: var(--pm-light);  color: var(--pm); }
.chip-learn { background: var(--gold-light); color: var(--gold); }
.chip-other { background: var(--paper2); color: var(--muted); }
.chip-hi  { background: #fdecea; color: var(--red); }
.chip-med { background: #e8f5e9; color: #2e7d32; }
.chip-lo  { background: var(--paper2); color: var(--muted); }
.entry-outcome { margin-top: 7px; padding: 5px 9px; background: var(--dev-light); border-radius: 3px; font-size: 11px; color: var(--dev); font-family: 'DM Mono', monospace; }
.entry-outcome::before { content: '‚Üí '; }
.entry-actions { display: flex; gap: 4px; align-items: center; flex-shrink: 0; }
.sync-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; margin-left: 3px; }
.sync-dot.ok   { background: #27ae60; } .sync-dot.pend { background: var(--gold); }
.empty { text-align: center; padding: 56px 20px; color: var(--muted); }
.empty-icon { font-size: 32px; margin-bottom: 10px; }
.empty h3 { font-family: 'Playfair Display', serif; font-size: 19px; color: var(--text); margin-bottom: 5px; }

/* MODALS shared */
.modal-backdrop { position: fixed; inset: 0; background: rgba(14,14,20,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.modal-backdrop.open { opacity: 1; pointer-events: all; }
.modal { background: var(--paper); border: 1.5px solid var(--rule); border-radius: 8px; padding: 26px 28px; width: 100%; max-height: 90vh; overflow-y: auto; transform: translateY(14px); transition: transform 0.2s; box-shadow: 0 16px 48px rgba(14,14,20,0.2); }
.modal-backdrop.open .modal { transform: translateY(0); }
.modal-lg { max-width: 700px; }
.modal-sm { max-width: 620px; }
.modal-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-title { font-family: 'Playfair Display', serif; font-size: 21px; font-weight: 800; }
.modal-close { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--muted); padding: 0 4px; line-height: 1; }

/* SHEET LIST in manage modal */
.sheet-list-item { display: flex; align-items: center; gap: 12px; padding: 13px 16px; background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; margin-bottom: 8px; transition: all 0.15s; }
.sheet-list-item.is-active { border-color: var(--dev); }
.sheet-list-item:hover { box-shadow: 0 2px 8px var(--shadow); }
.sli-name { font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 14px; flex: 1; }
.sli-id   { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); }
.sli-count { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); white-space: nowrap; }
.sli-actions { display: flex; gap: 6px; flex-shrink: 0; }
.active-badge { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px; text-transform: uppercase; padding: 2px 7px; border-radius: 2px; background: var(--dev-light); color: var(--dev); }
.add-form { background: var(--gold-light); border: 1.5px solid var(--gold); border-radius: 6px; padding: 18px 20px; margin-top: 18px; }
.add-form h4 { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 700; margin-bottom: 12px; }
.add-form p { font-size: 12px; color: var(--muted); margin-bottom: 12px; line-height: 1.7; }
.add-form code { font-family: 'DM Mono', monospace; font-size: 11px; background: rgba(200,151,58,0.18); padding: 1px 5px; border-radius: 3px; color: var(--pm); }

/* Color swatches */
.swatches { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
.swatch { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2.5px solid transparent; transition: all 0.15s; }
.swatch.sel { border-color: var(--ink); transform: scale(1.18); }
.swatch:hover:not(.sel) { transform: scale(1.1); }

/* API setup section */
.api-section { border-top: 1px solid var(--rule); padding-top: 18px; margin-top: 16px; }

/* REPORT */
.report-card { background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; padding: 28px 32px; box-shadow: 0 2px 14px var(--shadow); }
.rc-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 16px; border-bottom: 2px solid var(--ink); margin-bottom: 22px; flex-wrap: wrap; gap: 10px; }
.rc-title { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 900; letter-spacing: -0.5px; }
.rc-month { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); margin-top: 3px; }
.rc-stamp { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 900; color: var(--dev); border: 3px solid var(--dev); border-radius: 4px; padding: 2px 11px; transform: rotate(-3deg); opacity: 0.85; text-transform: uppercase; letter-spacing: 1px; }
.grade-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 22px; }
@media(max-width:580px){ .grade-grid { grid-template-columns: repeat(2,1fr); } }
.grade-box { border: 1.5px solid var(--rule); border-radius: 6px; padding: 12px; text-align: center; }
.grade-letter { font-family: 'Playfair Display', serif; font-size: 44px; font-weight: 900; line-height: 1; }
.grade-A { color: var(--dev); } .grade-B { color: #1565c0; } .grade-C { color: var(--gold); } .grade-D { color: var(--red); }
.grade-lbl { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; margin-top: 4px; }
.grade-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }
.stat-strip { display: grid; grid-template-columns: repeat(auto-fit,minmax(95px,1fr)); gap: 10px; margin-bottom: 22px; }
.stat-item { border-left: 3px solid var(--rule); padding: 5px 9px; }
.stat-num { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 900; }
.stat-lbl { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px; color: var(--muted); text-transform: uppercase; }
.act-dots { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 7px; }
.act-dot { width: 19px; height: 19px; border-radius: 3px; position: relative; cursor: default; }
.act-dot:hover::after { content: attr(data-tip); position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); background: var(--ink); color: #fff; font-family: 'DM Mono', monospace; font-size: 9px; padding: 3px 6px; border-radius: 3px; white-space: nowrap; z-index: 10; }
.a-empty { background: var(--paper2); border: 1px solid var(--rule); }
.a-dev   { background: var(--dev);  opacity: 0.72; }
.a-pm    { background: var(--pm);   opacity: 0.72; }
.a-both  { background: linear-gradient(135deg, var(--dev), var(--pm)); opacity: 0.8; }
.a-learn { background: var(--gold); opacity: 0.72; }
.ins-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
@media(max-width:600px){ .ins-grid { grid-template-columns: 1fr; } }
.ins-box { border: 1.5px solid var(--rule); border-radius: 6px; padding: 14px 16px; }
.ins-box-title { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 10px; }
.ins-item { display: flex; gap: 8px; font-size: 13px; line-height: 1.6; margin-bottom: 7px; }
.ins-item:last-child { margin-bottom: 0; }
.ins-dot { width: 5px; height: 5px; border-radius: 50%; margin-top: 7px; flex-shrink: 0; }
.summary-box { background: var(--dev-light); border: 1.5px solid rgba(26,77,62,0.18); border-radius: 6px; padding: 14px 18px; margin-bottom: 20px; }
.rc-divider { border: none; border-top: 2px dashed var(--rule); margin: 24px 0; }
.manual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 13px; }
@media(max-width:580px){ .manual-grid { grid-template-columns: 1fr; } }
.manual-full { grid-column: 1/-1; }
.star-row { display: flex; gap: 5px; margin-top: 6px; }
.star-btn { background: none; border: none; font-size: 21px; cursor: pointer; color: var(--rule); transition: color 0.1s; }
.star-btn.on { color: var(--gold); }
.badge { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 2px; padding: 2px 7px; border-radius: 2px; text-transform: uppercase; }
.badge-ai   { background: var(--dev-light); color: var(--dev); }
.badge-self { background: var(--pm-light);  color: var(--pm); }

/* TOAST */
.toast { position: fixed; bottom: 20px; right: 20px; z-index: 999; background: var(--ink); color: var(--paper); font-family: 'DM Mono', monospace; font-size: 12px; letter-spacing: 0.5px; padding: 10px 17px; border-radius: 4px; transform: translateY(70px); opacity: 0; transition: all 0.27s; box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
.toast.show { transform: translateY(0); opacity: 1; }
.toast.ok  { background: var(--dev); }
.toast.err { background: var(--red); }
.panel { display: none; } .panel.active { display: block; }
.spin { width: 32px; height: 32px; border: 3px solid var(--rule); border-top-color: var(--dev); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px; }
@keyframes spin { to{transform:rotate(360deg)} }
.loading-wrap { text-align: center; padding: 42px 20px; }
.loading-txt { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--muted); }
.loading-txt::after { content: '...'; animation: ell 1.5s infinite; }
@keyframes ell { 0%{content:'.'} 33%{content:'..'} 66%{content:'...'} }
</style>
</head>
<body>
<div class="wrap">

<!-- HEADER -->
<header class="top-bar">
  <div>
    <div class="logo">Foot<em>print</em></div>
    <div class="logo-sub">Growth Portal ¬∑ Dev &amp; PM</div>
  </div>
  <div class="header-right">
    <div class="current-date" id="dateDisp"></div>
    <div class="sheet-switcher" id="sheetSwitcher"></div>
  </div>
</header>

<!-- TABS -->
<div class="tabs">
  <button class="tab active" onclick="gotoTab('log',this)">üìù Log Task</button>
  <button class="tab" onclick="gotoTab('history',this)">üìã History</button>
  <button class="tab" onclick="gotoTab('report',this)">üìä Report Card</button>
</div>

<!-- LOG PANEL -->
<div id="panel-log" class="panel active">
  <div id="logBar" class="active-bar" style="display:none"></div>
  <div class="log-card">
    <div class="section-label">New Entry</div>
    <div class="frow c2">
      <div class="field"><label>Date</label><input type="date" id="fDate"></div>
      <div class="field"><label>Task Title</label><input type="text" id="fTitle" placeholder="What did you work on?"></div>
    </div>
    <div class="frow">
      <div class="field"><label>Description</label>
        <textarea id="fDesc" placeholder="Describe what you built, decided, reviewed, or learned. More detail ‚Üí better AI report."></textarea>
      </div>
    </div>
    <div class="frow c3">
      <div class="field"><label>Impact</label>
        <select id="fImpact">
          <option value="low">üü° Low ‚Äî Routine</option>
          <option value="medium" selected>üü¢ Medium ‚Äî Meaningful</option>
          <option value="high">üî¥ High ‚Äî Milestone</option>
        </select>
      </div>
      <div class="field"><label>Key Outcome / Learning</label><input type="text" id="fOutcome" placeholder="What did you learn or ship?"></div>
      <div class="field"><label>Effort (hrs)</label><input type="number" id="fEffort" placeholder="2.5" min="0" step="0.5"></div>
    </div>
    <div class="field">
      <label>Categories</label>
      <div class="cats-wrap" id="logCats">
        <div class="cat-chip" data-cat="dev"     data-sel="dev"   onclick="toggleCat(this)">üñ• Dev</div>
        <div class="cat-chip" data-cat="pm"      data-sel="pm"    onclick="toggleCat(this)">üì¶ PM</div>
        <div class="cat-chip" data-cat="learn"   data-sel="learn" onclick="toggleCat(this)">üìö Learning</div>
        <div class="cat-chip" data-cat="review"  data-sel="other" onclick="toggleCat(this)">üîç Review</div>
        <div class="cat-chip" data-cat="design"  data-sel="other" onclick="toggleCat(this)">üé® Design</div>
        <div class="cat-chip" data-cat="infra"   data-sel="other" onclick="toggleCat(this)">‚öôÔ∏è Infra</div>
        <div class="cat-chip" data-cat="collab"  data-sel="other" onclick="toggleCat(this)">ü§ù Collab</div>
        <div class="cat-chip" data-cat="bug"     data-sel="other" onclick="toggleCat(this)">üêõ Bug Fix</div>
        <div class="cat-chip" data-cat="meeting" data-sel="other" onclick="toggleCat(this)">üó£ Meeting</div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="addEntry()">+ Add Entry</button>
      <button class="btn btn-outline" onclick="clearForm()">Clear</button>
      <span class="save-hint" id="saveHint"></span>
    </div>
  </div>
</div>

<!-- HISTORY PANEL -->
<div id="panel-history" class="panel">
  <div class="filter-bar">
    <div class="field"><label>Month</label><input type="month" id="fMonth" onchange="renderHistory()"></div>
    <div class="field"><label>Sheet</label>
      <select id="fSheetH" onchange="renderHistory()">
        <option value="">All Sheets</option>
      </select>
    </div>
    <div class="field"><label>Category</label>
      <select id="fCat" onchange="renderHistory()">
        <option value="">All</option>
        <option value="dev">Dev</option><option value="pm">PM</option>
        <option value="learn">Learning</option><option value="review">Review</option>
        <option value="design">Design</option><option value="infra">Infra</option>
        <option value="collab">Collab</option><option value="bug">Bug Fix</option><option value="meeting">Meeting</option>
      </select>
    </div>
    <div class="field"><label>Impact</label>
      <select id="fImpH" onchange="renderHistory()">
        <option value="">All</option>
        <option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option>
      </select>
    </div>
    <div style="align-self:flex-end;display:flex;gap:7px">
      <button class="btn btn-outline btn-sm" id="syncBtn" onclick="syncAllPending()" style="display:none">‚Üë Sync All</button>
    </div>
    <div style="align-self:flex-end;font-family:DM Mono,monospace;font-size:11px;color:var(--muted);padding-bottom:2px" id="histCount"></div>
  </div>
  <div id="histList"></div>
</div>

<!-- REPORT PANEL -->
<div id="panel-report" class="panel">
  <div class="log-card" style="margin-bottom:20px">
    <div class="section-label">Generate Report</div>
    <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
      <div class="field"><label>Month</label><input type="month" id="rMonth"></div>
      <div class="field"><label>Filter by Sheet</label>
        <select id="fSheetR">
          <option value="">All Sheets</option>
        </select>
      </div>
      <button class="btn btn-gold" onclick="generateReport()">‚ú® Generate AI Report</button>
      <button class="btn btn-outline" id="saveReflBtn" onclick="saveReflections()" style="display:none">üíæ Save Reflections</button>
      <button class="btn btn-outline" id="exportRptBtn" onclick="exportReport()" style="display:none">‚¨áÔ∏è Export .txt</button>
      <button class="btn btn-danger" id="deleteRptBtn" onclick="deleteReport()" style="display:none;font-size:11px;padding:10px 18px">üóë Delete</button>
    </div>
  </div>
  <div id="reportOut"></div>
</div>

</div><!-- /wrap -->

<!-- MANAGE SHEETS MODAL -->
<div class="modal-backdrop" id="mgModal" onclick="closeBgMg(event)">
  <div class="modal modal-lg">
    <div class="modal-hdr">
      <div class="modal-title">Manage Sheets</div>
      <button class="modal-close" onclick="closeMgModal()">√ó</button>
    </div>
    <div id="sheetListEl"></div>
    <div class="add-form">
      <h4>+ Connect a New Sheet</h4>
      <p>Create a blank Google Sheet, then copy its ID from the URL:<br>
        <code>docs.google.com/spreadsheets/d/<strong>SHEET_ID</strong>/edit</code>
      </p>
      <div class="frow c2" style="margin-bottom:12px">
        <div class="field"><label>Sheet Name</label><input type="text" id="nsName" placeholder="e.g. Work Projects"></div>
        <div class="field"><label>Google Sheet ID</label><input type="text" id="nsSheetId" placeholder="1BxiMVs0XRA5nFMd‚Ä¶"></div>
      </div>
      <div class="field" style="margin-bottom:14px">
        <label>Color Label</label>
        <div class="swatches" id="colorSwatches">
          <div class="swatch sel" data-color="#1a4d3e" style="background:#1a4d3e" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#5c1a00" style="background:#5c1a00" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#c8973a" style="background:#c8973a" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#1565c0" style="background:#1565c0" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#6a1b9a" style="background:#6a1b9a" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#c62828" style="background:#c62828" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#00695c" style="background:#00695c" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#4e342e" style="background:#4e342e" onclick="pickColor(this)"></div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="addNewSheet()">Add Sheet</button>
    </div>
    <!-- Client ID setup -->
    <div class="api-section" id="apiSection">
      <div class="section-label" style="margin-bottom:12px">Google API Connection</div>
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.7">
        Enable <code>Google Sheets API</code> in <code>console.cloud.google.com</code>, create an
        OAuth 2.0 Web Application credential, and add your site URL to Authorized JavaScript Origins.
      </p>
      <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
        <div class="field" style="flex:1;min-width:200px"><label>Google OAuth Client ID</label>
          <input type="text" id="cfgClientId" placeholder="xxxx.apps.googleusercontent.com">
        </div>
        <button class="btn btn-primary" onclick="saveClientId()">Save &amp; Connect</button>
        <div id="authStatus" style="font-family:DM Mono,monospace;font-size:11px;color:var(--muted);align-self:flex-end;padding-bottom:2px"></div>
      </div>
    </div>
  </div>
</div>

<!-- EDIT ENTRY MODAL -->
<div class="modal-backdrop" id="editModal" onclick="closeBgEdit(event)" style="z-index:100">
  <div class="modal modal-sm">
    <div class="modal-hdr">
      <div class="modal-title">Edit Entry</div>
      <button class="modal-close" onclick="closeEditModal()">√ó</button>
    </div>
    <div class="frow c2">
      <div class="field"><label>Date</label><input type="date" id="mDate"></div>
      <div class="field"><label>Task Title</label><input type="text" id="mTitle"></div>
    </div>
    <div class="frow" style="margin-bottom:14px">
      <div class="field"><label>Description</label><textarea id="mDesc" style="min-height:76px"></textarea></div>
    </div>
    <div class="frow c3">
      <div class="field"><label>Impact</label>
        <select id="mImpact">
          <option value="low">üü° Low</option>
          <option value="medium">üü¢ Medium</option>
          <option value="high">üî¥ High</option>
        </select>
      </div>
      <div class="field"><label>Outcome</label><input type="text" id="mOutcome"></div>
      <div class="field"><label>Effort (hrs)</label><input type="number" id="mEffort" min="0" step="0.5"></div>
    </div>
    <div class="field" style="margin-bottom:16px">
      <label>Categories</label>
      <div class="cats-wrap" id="modalCats">
        <div class="cat-chip" data-cat="dev"     data-sel="dev"   onclick="toggleCat(this)">üñ• Dev</div>
        <div class="cat-chip" data-cat="pm"      data-sel="pm"    onclick="toggleCat(this)">üì¶ PM</div>
        <div class="cat-chip" data-cat="learn"   data-sel="learn" onclick="toggleCat(this)">üìö Learning</div>
        <div class="cat-chip" data-cat="review"  data-sel="other" onclick="toggleCat(this)">üîç Review</div>
        <div class="cat-chip" data-cat="design"  data-sel="other" onclick="toggleCat(this)">üé® Design</div>
        <div class="cat-chip" data-cat="infra"   data-sel="other" onclick="toggleCat(this)">‚öôÔ∏è Infra</div>
        <div class="cat-chip" data-cat="collab"  data-sel="other" onclick="toggleCat(this)">ü§ù Collab</div>
        <div class="cat-chip" data-cat="bug"     data-sel="other" onclick="toggleCat(this)">üêõ Bug Fix</div>
        <div class="cat-chip" data-cat="meeting" data-sel="other" onclick="toggleCat(this)">üó£ Meeting</div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
      <button class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let entries     = JSON.parse(localStorage.getItem('fp_entries') || '[]');
let cfg         = JSON.parse(localStorage.getItem('fp_cfg')     || '{"sheets":[],"activeSheetId":null,"clientId":null}');
let reflections = JSON.parse(localStorage.getItem('fp_refl')    || '{}');

if (!cfg.sheets) cfg.sheets = [];

let gapiReady  = false;
let signedIn   = false;
let editingId  = null;
let newColor   = '#1a4d3e';
let currentRating = 0;
let currentReportMonth = null;
let currentReport = null;

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function save()         { localStorage.setItem('fp_entries', JSON.stringify(entries)); }
function saveCfg()      { localStorage.setItem('fp_cfg',     JSON.stringify(cfg)); }
function saveReflStore(){ localStorage.setItem('fp_refl',    JSON.stringify(reflections)); }
function uid()          { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function activeSheet()  { return cfg.sheets.find(s => s.id === cfg.activeSheetId) || null; }
function sheetById(id)  { return cfg.sheets.find(s => s.id === id) || null; }
function toast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + type;
  setTimeout(() => t.className = 'toast', 3000);
}

const CAT_SEL = { dev:'sel-dev', pm:'sel-pm', learn:'sel-learn' };
function catSelCls(cat) { return CAT_SEL[cat] || 'sel-other'; }

function toggleCat(el) { el.classList.toggle(catSelCls(el.dataset.cat)); }
function getSelCats(cid) {
  return [...document.querySelectorAll(`#${cid} .cat-chip`)].filter(c => c.className.match(/sel-/)).map(c => c.dataset.cat);
}
function setSelCats(cid, cats) {
  document.querySelectorAll(`#${cid} .cat-chip`).forEach(c => {
    ['sel-dev','sel-pm','sel-learn','sel-other'].forEach(cl => c.classList.remove(cl));
    if ((cats||[]).includes(c.dataset.cat)) c.classList.add(catSelCls(c.dataset.cat));
  });
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const now = new Date();
  document.getElementById('dateDisp').textContent = now.toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('fDate').value = now.toISOString().split('T')[0];
  const ym = now.toISOString().slice(0,7);
  ['fMonth','rMonth'].forEach(id => document.getElementById(id).value = ym);
  renderSwitcher();
  renderDropdowns();
  updateLogBar();
  if (cfg.clientId) loadGapi();
})();

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function gotoTab(name, el) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  el.classList.add('active');
  if (name === 'history') renderHistory();
}

// ‚îÄ‚îÄ‚îÄ SHEET SWITCHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSwitcher() {
  const sw = document.getElementById('sheetSwitcher');
  let html = cfg.sheets.map(s => `
    <button class="sh-tab ${s.id===cfg.activeSheetId?'active':''}" onclick="setActive('${s.id}')">
      <span class="sh-cdot" style="background:${s.color||'#1a4d3e'}"></span>
      ${s.name}
      <span class="sh-sdot ${signedIn?'ok':'off'}" title="${signedIn?'Syncing':'Not connected'}"></span>
    </button>`).join('');
  html += `<button class="btn-add-sheet" onclick="openMgModal()">+ Sheet</button>`;
  html += `<button class="btn-mgr" onclick="openMgModal()">‚öô Manage</button>`;
  sw.innerHTML = html;
}

function setActive(id) {
  cfg.activeSheetId = id; saveCfg();
  renderSwitcher(); renderDropdowns(); updateLogBar(); renderHistory();
}

function updateLogBar() {
  const bar = document.getElementById('logBar');
  const s = activeSheet();
  if (!s) { bar.style.display = 'none'; return; }
  bar.style.display = 'flex';
  const total   = entries.filter(e => e.sheetId === s.id).length;
  const pending = entries.filter(e => e.sheetId === s.id && !e.synced).length;
  bar.innerHTML = `
    <span class="sh-cdot" style="background:${s.color};width:10px;height:10px"></span>
    <span class="ab-name">${s.name}</span>
    <span class="ab-info">${total} entries${pending?` ¬∑ ${pending} pending`:''}</span>
    <span class="ab-status">
      <span class="sh-sdot ${signedIn?'ok':'off'}"></span>
      ${signedIn?'Syncing to Google Sheets':'Not connected ‚Äî entries saved locally'}
    </span>`;
}

function renderDropdowns() {
  const opts = '<option value="">All Sheets</option>' +
    cfg.sheets.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  ['fSheetH','fSheetR'].forEach(id => {
    const el = document.getElementById(id); if (!el) return;
    const v = el.value; el.innerHTML = opts; el.value = v;
  });
}

// ‚îÄ‚îÄ‚îÄ MANAGE SHEETS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openMgModal() {
  renderSheetList();
  if (cfg.clientId) document.getElementById('cfgClientId').value = cfg.clientId;
  document.getElementById('authStatus').textContent = signedIn ? '‚úì Connected' : cfg.clientId ? 'Connecting‚Ä¶' : '';
  document.getElementById('mgModal').classList.add('open');
}
function closeMgModal() { document.getElementById('mgModal').classList.remove('open'); }
function closeBgMg(e)   { if (e.target===document.getElementById('mgModal')) closeMgModal(); }

function renderSheetList() {
  const el = document.getElementById('sheetListEl');
  if (!cfg.sheets.length) {
    el.innerHTML = '<p style="font-size:13px;color:var(--muted);margin-bottom:16px">No sheets connected yet. Add one below.</p>';
    return;
  }
  el.innerHTML = cfg.sheets.map(s => {
    const count = entries.filter(e => e.sheetId===s.id).length;
    const isActive = s.id === cfg.activeSheetId;
    return `
    <div class="sheet-list-item ${isActive?'is-active':''}">
      <span class="sh-cdot" style="background:${s.color||'#1a4d3e'};width:14px;height:14px;flex-shrink:0"></span>
      <div style="flex:1;min-width:0">
        <div class="sli-name">${s.name} ${isActive?'<span class="active-badge">Active</span>':''}</div>
        <div class="sli-id" style="margin-top:2px">${s.sheetId ? 'ID: '+s.sheetId.slice(0,30)+'‚Ä¶' : 'No Sheet ID set'}</div>
      </div>
      <div class="sli-count">${count} entries</div>
      <div class="sli-actions">
        ${!isActive?`<button class="btn btn-outline btn-sm" onclick="setActive('${s.id}');renderSheetList()">Set Active</button>`:''}
        <button class="btn btn-danger btn-sm" onclick="removeSheet('${s.id}')">Remove</button>
      </div>
    </div>`;
  }).join('');
}

function pickColor(el) {
  document.querySelectorAll('.swatch').forEach(s => s.classList.remove('sel'));
  el.classList.add('sel'); newColor = el.dataset.color;
}

function addNewSheet() {
  const name    = document.getElementById('nsName').value.trim();
  const sheetId = document.getElementById('nsSheetId').value.trim();
  if (!name)    { toast('Enter a sheet name','err'); return; }
  if (!sheetId) { toast('Enter a Google Sheet ID','err'); return; }
  const sheet = { id: uid(), name, sheetId, color: newColor, tab: 'Sheet1' };
  cfg.sheets.push(sheet);
  if (!cfg.activeSheetId) cfg.activeSheetId = sheet.id;
  saveCfg();
  document.getElementById('nsName').value = '';
  document.getElementById('nsSheetId').value = '';
  renderSheetList(); renderSwitcher(); renderDropdowns(); updateLogBar();
  if (signedIn) ensureHeaders(sheet);
  toast(`"${name}" connected!`, 'ok');
}

function removeSheet(id) {
  const s = sheetById(id); if (!s) return;
  const n = entries.filter(e=>e.sheetId===id).length;
  if (!confirm(`Remove sheet "${s.name}"?\n\n${n>0?n+' entries will keep their local data but won\'t sync.\n\n':''}The Google Sheet itself will NOT be deleted.`)) return;
  cfg.sheets = cfg.sheets.filter(sh => sh.id !== id);
  if (cfg.activeSheetId === id) cfg.activeSheetId = cfg.sheets[0]?.id || null;
  saveCfg();
  renderSheetList(); renderSwitcher(); renderDropdowns(); updateLogBar();
  toast(`"${s.name}" removed`);
}

function saveClientId() {
  const cid = document.getElementById('cfgClientId').value.trim();
  if (!cid) { toast('Enter your Client ID','err'); return; }
  cfg.clientId = cid; saveCfg();
  document.getElementById('authStatus').textContent = 'Connecting‚Ä¶';
  // Reset state so loadGapi reinitialises cleanly
  tokenClient = null; accessToken = null; gapiReady = false; signedIn = false;
  loadGapi();
}

// ‚îÄ‚îÄ‚îÄ GAPI (Google Identity Services) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tokenClient = null;
let accessToken = null;

function loadGapi() {
  if (!cfg.clientId) return;

  // Load gapi client (for Sheets API calls)
  if (!window.gapi) {
    const sc = document.createElement('script');
    sc.src = 'https://apis.google.com/js/api.js';
    sc.onload = () => gapi.load('client', initGapiClient);
    sc.onerror = () => toast('Failed to load Google API','err');
    document.head.appendChild(sc);
  } else {
    gapi.load('client', initGapiClient);
  }

  // Load GIS token client (replaces deprecated auth2)
  if (!window.google?.accounts) {
    const sc2 = document.createElement('script');
    sc2.src = 'https://accounts.google.com/gsi/client';
    sc2.onload = initTokenClient;
    sc2.onerror = () => toast('Failed to load Google Identity Services','err');
    document.head.appendChild(sc2);
  } else {
    initTokenClient();
  }
}

async function initGapiClient() {
  try {
    await gapi.client.init({});
    await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4');
    gapiReady = true;
    // If we already have a token (e.g. page reload), apply it
    if (accessToken) gapi.client.setToken({ access_token: accessToken });
  } catch(e) {
    toast('Failed to init Google Sheets client','err');
  }
}

function initTokenClient() {
  if (!cfg.clientId) return;
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: cfg.clientId,
    scope: 'https://www.googleapis.com/auth/spreadsheets',
    callback: (tokenResponse) => {
      if (tokenResponse.error) {
        toast('Google Auth error ‚Äî check Client ID & authorized origins','err');
        document.getElementById('authStatus').textContent = '‚úï Auth failed';
        return;
      }
      accessToken = tokenResponse.access_token;
      if (gapiReady) gapi.client.setToken({ access_token: accessToken });
      onSignIn(true);
    },
  });
  // Auto-request token (no popup if already consented)
  tokenClient.requestAccessToken({ prompt: '' });
}

function onSignIn(ok) {
  signedIn = ok;
  if (ok) {
    // GIS doesn't expose profile easily without extra call; show generic confirmation
    const status = document.getElementById('authStatus');
    if (status) status.textContent = '‚úì Connected';
    cfg.sheets.forEach(s => ensureHeaders(s));
    syncAllPending();
  }
  renderSwitcher(); updateLogBar();
}

async function ensureHeaders(sh) {
  if (!signedIn || !sh?.sheetId) return;
  try {
    const r = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: sh.sheetId, range: `${sh.tab||'Sheet1'}!A1` });
    if (!r.result.values || r.result.values[0][0] !== 'Date') {
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: sh.sheetId, range: `${sh.tab||'Sheet1'}!A1`, valueInputOption: 'RAW',
        resource: { values: [['Date','Title','Description','Categories','Impact','Outcome','Effort (hrs)','Month','ID','Created','Sheet Name']] }
      });
    }
  } catch(e) {}
}

async function pushEntry(entry) {
  if (!signedIn) return false;
  const sh = sheetById(entry.sheetId);
  if (!sh?.sheetId) return false;
  try {
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: sh.sheetId, range: `${sh.tab||'Sheet1'}!A:K`,
      valueInputOption: 'RAW', insertDataOption: 'INSERT_ROWS',
      resource: { values: [[ entry.date, entry.title, entry.desc||'', (entry.cats||[]).join(', '),
        entry.impact||'', entry.outcome||'', entry.effort||'',
        entry.month, String(entry.id), entry.created||'', sh.name ]] }
    });
    return true;
  } catch(e) { return false; }
}

async function syncAllPending() {
  const pending = entries.filter(e => !e.synced && e.sheetId);
  if (!pending.length) return;
  let n = 0;
  for (const e of pending) { const ok = await pushEntry(e); if (ok) { e.synced = true; n++; } }
  if (n) { save(); updateLogBar(); if (document.getElementById('panel-history').classList.contains('active')) renderHistory(); }
}

// ‚îÄ‚îÄ‚îÄ ADD ENTRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addEntry() {
  const date    = document.getElementById('fDate').value;
  const title   = document.getElementById('fTitle').value.trim();
  if (!date||!title) { toast('Date and title required','err'); return; }
  const as = activeSheet();
  const entry = {
    id: Date.now(), date, title,
    desc:    document.getElementById('fDesc').value.trim(),
    cats:    getSelCats('logCats'),
    impact:  document.getElementById('fImpact').value,
    outcome: document.getElementById('fOutcome').value.trim(),
    effort:  document.getElementById('fEffort').value,
    month: date.slice(0,7), synced: false, created: new Date().toISOString(),
    sheetId: as?.id||null, sheetName: as?.name||null
  };
  entries.unshift(entry); save();
  document.getElementById('saveHint').textContent = 'Saving‚Ä¶';
  const ok = await pushEntry(entry);
  entry.synced = ok; save(); updateLogBar();
  document.getElementById('saveHint').textContent = ok ? '‚úì Synced' : '‚óã Saved locally';
  setTimeout(() => document.getElementById('saveHint').textContent = '', 3000);
  clearForm();
  toast(ok ? '‚úÖ Entry saved & synced!' : '‚úÖ Saved locally', 'ok');
}

function clearForm() {
  ['fTitle','fDesc','fOutcome','fEffort'].forEach(id => document.getElementById(id).value='');
  document.getElementById('fImpact').value = 'medium';
  document.getElementById('fDate').value = new Date().toISOString().split('T')[0];
  setSelCats('logCats',[]);
}

function deleteEntry(id) {
  if (!confirm('Delete this entry?')) return;
  entries = entries.filter(e=>e.id!==id);
  save(); updateLogBar(); renderHistory(); toast('Entry deleted');
}

// ‚îÄ‚îÄ‚îÄ EDIT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEdit(id) {
  const e = entries.find(e=>e.id===id); if (!e) return;
  editingId = id;
  document.getElementById('mDate').value    = e.date;
  document.getElementById('mTitle').value   = e.title;
  document.getElementById('mDesc').value    = e.desc||'';
  document.getElementById('mImpact').value  = e.impact||'medium';
  document.getElementById('mOutcome').value = e.outcome||'';
  document.getElementById('mEffort').value  = e.effort||'';
  setSelCats('modalCats', e.cats||[]);
  document.getElementById('editModal').classList.add('open');
}
async function saveEdit() {
  const e = entries.find(e=>e.id===editingId); if (!e) return;
  e.date    = document.getElementById('mDate').value;
  e.title   = document.getElementById('mTitle').value.trim();
  e.desc    = document.getElementById('mDesc').value.trim();
  e.cats    = getSelCats('modalCats');
  e.impact  = document.getElementById('mImpact').value;
  e.outcome = document.getElementById('mOutcome').value.trim();
  e.effort  = document.getElementById('mEffort').value;
  e.month   = e.date.slice(0,7);
  e.synced  = false;
  save(); closeEditModal(); renderHistory(); toast('Updated','ok');
  const ok = await pushEntry(e); if (ok) { e.synced=true; save(); renderHistory(); }
}
function closeEditModal() { document.getElementById('editModal').classList.remove('open'); editingId=null; }
function closeBgEdit(e)   { if (e.target===document.getElementById('editModal')) closeEditModal(); }

// ‚îÄ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHistory() {
  const fm  = document.getElementById('fMonth').value;
  const fsh = document.getElementById('fSheetH').value;
  const fc  = document.getElementById('fCat').value;
  const fi  = document.getElementById('fImpH').value;
  let list = [...entries];
  if (fm)  list = list.filter(e=>e.month===fm);
  if (fsh) list = list.filter(e=>e.sheetId===fsh);
  if (fc)  list = list.filter(e=>(e.cats||[]).includes(fc));
  if (fi)  list = list.filter(e=>e.impact===fi);

  document.getElementById('histCount').textContent = list.length+' entries';
  document.getElementById('syncBtn').style.display = (list.some(e=>!e.synced) && cfg.sheets.length) ? '':'none';

  const el = document.getElementById('histList');
  if (!list.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">üìì</div><h3>No entries found</h3><p>Try changing filters or log some tasks.</p></div>`;
    return;
  }
  const groups = {};
  list.forEach(e => { if (!groups[e.date]) groups[e.date]=[]; groups[e.date].push(e); });
  el.innerHTML = Object.keys(groups).sort((a,b)=>b.localeCompare(a)).map(date => {
    const de = groups[date];
    const dayCats = [...new Set(de.flatMap(e=>e.cats||[]))];
    const dayHrs  = de.reduce((s,e)=>s+(parseFloat(e.effort)||0),0);
    const dow = new Date(date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long'});
    const dtLbl = new Date(date+'T12:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
    const mainCat = e => {
      const c=e.cats||[];
      if(c.includes('dev')&&c.includes('pm')) return 't-both';
      if(c.includes('dev')) return 't-dev';
      if(c.includes('pm'))  return 't-pm';
      if(c.includes('learn')) return 't-learn';
      return '';
    };
    return `
<div class="day-group">
  <div class="day-header">
    <div><div class="day-date-label">${dtLbl}</div><div class="day-dow">${dow}</div></div>
    <div class="day-cat-pills">${dayCats.map(c=>`<span class="day-pill pill-${c}">${c}</span>`).join('')}</div>
    ${dayHrs>0?`<div class="day-hrs">${dayHrs.toFixed(1)}h</div>`:''}
  </div>
  ${de.map(e => {
    const sh = sheetById(e.sheetId);
    const impCls = e.impact==='high'?'chip-hi':e.impact==='medium'?'chip-med':'chip-lo';
    const sheetChip = sh ? `<span class="chip" style="background:${sh.color}18;color:${sh.color};border:1px solid ${sh.color}40">${sh.name}</span>` : '';
    return `
<div class="entry ${mainCat(e)}">
  <div class="entry-row">
    <div style="flex:1;min-width:0">
      <div class="entry-title">${e.title}</div>
      ${e.desc?`<div class="entry-desc">${e.desc}</div>`:''}
      <div class="entry-chips">
        ${(e.cats||[]).map(c=>`<span class="chip chip-${['dev','pm','learn'].includes(c)?c:'other'}">${c}</span>`).join('')}
        <span class="chip ${impCls}">${e.impact||'medium'}</span>
        ${e.effort?`<span class="chip chip-other">${e.effort}h</span>`:''}
        ${sheetChip}
        <span class="sync-dot ${e.synced?'ok':'pend'}" title="${e.synced?'Synced':'Pending'}"></span>
      </div>
      ${e.outcome?`<div class="entry-outcome">${e.outcome}</div>`:''}
    </div>
    <div class="entry-actions">
      <button class="btn btn-edit" onclick="openEdit(${e.id})">‚úé</button>
      <button class="btn btn-danger btn-sm" onclick="deleteEntry(${e.id})">‚úï</button>
    </div>
  </div>
</div>`;}).join('')}
</div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateReport() {
  const month = document.getElementById('rMonth').value;
  const fsh   = document.getElementById('fSheetR').value;
  if (!month) { toast('Select a month','err'); return; }
  let me = entries.filter(e=>e.month===month);
  if (fsh) me = me.filter(e=>e.sheetId===fsh);

  const out = document.getElementById('reportOut');
  if (!me.length) {
    out.innerHTML = `<div class="empty"><div class="empty-icon">üìä</div><h3>No entries for this period</h3><p>Log tasks first then generate your report.</p></div>`;
    return;
  }
  out.innerHTML = `<div class="loading-wrap"><div class="spin"></div><div class="loading-txt">Generating AI report</div></div>`;

  const log = me.map(e=>`[${e.date}] ${e.title} | cats:${(e.cats||[]).join(',')} | impact:${e.impact} | effort:${e.effort||'?'}h | outcome:${e.outcome||'N/A'} | sheet:${e.sheetName||'‚Äî'} | notes:${e.desc||''}`).join('\n');
  const prompt = `You are both a senior engineering manager and a product lead reviewing a developer's monthly work log.
Analyze this log for ${month} and return ONLY valid JSON (no markdown):

${log}

{"devGrade":"A|B|C|D","pmGrade":"A|B|C|D","overallGrade":"A|B|C|D","consistencyGrade":"A|B|C|D","devGradeReason":"one sentence","pmGradeReason":"one sentence","executiveSummary":"2-3 sentences","oneThingToRemember":"one memorable insight","devStrengths":["...","...","..."],"devImprove":["...","...","..."],"pmStrengths":["...","...","..."],"pmImprove":["...","...","..."],"topLearnings":["...","...","..."],"blindSpots":["...","..."],"nextMonthGoals":["...","...","..."]}`;

  let r;
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ model:'claude-sonnet-4-20250514', max_tokens:1500, messages:[{role:'user',content:prompt}] })
    });
    const data = await res.json();
    r = JSON.parse((data.content||[]).map(c=>c.text||'').join('').replace(/```json|```/g,'').trim());
  } catch(e) { r = fallbackReport(me); }

  currentReport = r;
  currentReportMonth = month + (fsh ? '::'+fsh : '');
  currentRating = (reflections[currentReportMonth]||{}).rating||0;
  renderReport(r, me, month, fsh);
  ['saveReflBtn','exportRptBtn','deleteRptBtn'].forEach(id => document.getElementById(id).style.display='');
}

function fallbackReport(me) {
  const dN=me.filter(e=>(e.cats||[]).includes('dev')).length;
  const pN=me.filter(e=>(e.cats||[]).includes('pm')).length;
  const g=n=>n>=15?'A':n>=8?'B':n>=4?'C':'D';
  return { devGrade:g(dN), pmGrade:g(pN), overallGrade:g(me.length), consistencyGrade:'B',
    devGradeReason:`${dN} dev tasks logged.`, pmGradeReason:`${pN} PM tasks logged.`,
    executiveSummary:`You logged ${me.length} entries this period. Add more detail for richer AI insights.`,
    oneThingToRemember:'Specificity in your logs creates clarity in your growth.',
    devStrengths:['Active development activity','Tracking outcomes','Cross-category work'],
    devImprove:['Add technical detail','Track deep work vs meetings','Document key decisions'],
    pmStrengths:['Growing product awareness','Logging cross-functional work','Outcome thinking'],
    pmImprove:['Log more PM-specific tasks','Add user impact context','Practice problem statements'],
    topLearnings: me.filter(e=>e.outcome).slice(0,3).map(e=>e.outcome).filter(Boolean),
    blindSpots:['Under-representing PM work','Missing effort estimates'],
    nextMonthGoals:['1 PM task per week','Effort hrs on every entry','Weekly retro entry'] };
}

function renderReport(r, me, month, fsh) {
  const label = new Date(month+'-02').toLocaleString('default',{month:'long',year:'numeric'});
  const dN = me.filter(e=>(e.cats||[]).includes('dev')).length;
  const pN = me.filter(e=>(e.cats||[]).includes('pm')).length;
  const hN = me.filter(e=>e.impact==='high').length;
  const oN = me.filter(e=>e.outcome).length;
  const hrs = me.reduce((s,e)=>s+(parseFloat(e.effort)||0),0);
  const daysIn = new Date(month.split('-')[0],parseInt(month.split('-')[1]),0).getDate();
  const dayMap = {};
  me.forEach(e=>{
    const d=parseInt(e.date.split('-')[2]),c=e.cats||[];
    if(c.includes('dev')&&c.includes('pm')) dayMap[d]='both';
    else if(c.includes('dev')) dayMap[d]=dayMap[d]||'dev';
    else if(c.includes('pm'))  dayMap[d]=dayMap[d]||'pm';
    else if(c.includes('learn')) dayMap[d]=dayMap[d]||'learn';
    else dayMap[d]=dayMap[d]||'dev';
  });
  const dots = Array.from({length:daysIn},(_,i)=>{
    const t=dayMap[i+1];
    return `<div class="act-dot ${t?'a-'+t:'a-empty'}" data-tip="Day ${i+1}${t?' ‚Äî '+t:''}"></div>`;
  }).join('');
  const ins = (arr,col) => (arr||[]).map(s=>`<div class="ins-item"><div class="ins-dot" style="background:${col}"></div><div>${s}</div></div>`).join('');
  const ref = reflections[currentReportMonth]||{};
  const sh  = fsh ? sheetById(fsh) : null;

  document.getElementById('reportOut').innerHTML = `
<div class="report-card">
  <div class="rc-header">
    <div>
      <div class="rc-title">Monthly Report Card</div>
      <div class="rc-month">${label} ¬∑ ${sh?`<span style="color:${sh.color}">${sh.name}</span>`:'All Sheets'} ¬∑ ${me.length} entries</div>
    </div>
    <div class="rc-stamp">${r.overallGrade}</div>
  </div>
  <div class="grade-grid">
    <div class="grade-box"><div class="grade-letter grade-${r.devGrade}">${r.devGrade}</div><div class="grade-lbl">Dev Skills</div><div class="grade-sub">${r.devGradeReason}</div></div>
    <div class="grade-box"><div class="grade-letter grade-${r.pmGrade}">${r.pmGrade}</div><div class="grade-lbl">PM Thinking</div><div class="grade-sub">${r.pmGradeReason}</div></div>
    <div class="grade-box"><div class="grade-letter grade-${r.consistencyGrade}">${r.consistencyGrade}</div><div class="grade-lbl">Consistency</div><div class="grade-sub">${Object.keys(dayMap).length} active days</div></div>
    <div class="grade-box"><div class="grade-letter grade-${r.overallGrade}">${r.overallGrade}</div><div class="grade-lbl">Overall</div><div class="grade-sub">${hN} high-impact</div></div>
  </div>
  <div class="stat-strip">
    <div class="stat-item"><div class="stat-num">${me.length}</div><div class="stat-lbl">Entries</div></div>
    <div class="stat-item" style="border-left-color:var(--dev)"><div class="stat-num">${dN}</div><div class="stat-lbl">Dev</div></div>
    <div class="stat-item" style="border-left-color:var(--pm)"><div class="stat-num">${pN}</div><div class="stat-lbl">PM</div></div>
    <div class="stat-item" style="border-left-color:var(--red)"><div class="stat-num">${hN}</div><div class="stat-lbl">High Impact</div></div>
    <div class="stat-item"><div class="stat-num">${oN}</div><div class="stat-lbl">Outcomes</div></div>
    <div class="stat-item" style="border-left-color:var(--gold)"><div class="stat-num">${hrs>0?hrs.toFixed(1):'‚Äî'}</div><div class="stat-lbl">Hours</div></div>
  </div>
  <div class="summary-box">
    <div class="ins-box-title" style="color:var(--dev);margin-bottom:7px">‚ú® AI Summary <span class="badge badge-ai" style="margin-left:4px">AI</span></div>
    <p style="font-size:14px;line-height:1.75">${r.executiveSummary}</p>
    ${r.oneThingToRemember?`<p style="margin-top:9px;font-size:13px;font-family:DM Mono,monospace;color:var(--dev);font-style:italic">"${r.oneThingToRemember}"</p>`:''}
  </div>
  <div style="margin-bottom:20px">
    <div class="ins-box-title" style="margin-bottom:9px">Activity ‚Äî ${label}</div>
    <div class="act-dots">${dots}</div>
    <div style="display:flex;gap:14px;margin-top:6px;font-family:DM Mono,monospace;font-size:10px;color:var(--muted)">
      <span><span style="display:inline-block;width:10px;height:10px;background:var(--dev);opacity:.7;border-radius:2px;margin-right:4px"></span>Dev</span>
      <span><span style="display:inline-block;width:10px;height:10px;background:var(--pm);opacity:.7;border-radius:2px;margin-right:4px"></span>PM</span>
      <span><span style="display:inline-block;width:10px;height:10px;background:var(--gold);opacity:.7;border-radius:2px;margin-right:4px"></span>Learn</span>
    </div>
  </div>
  <div class="ins-grid">
    <div class="ins-box"><div class="ins-box-title">üñ• Dev ‚Äî Strengths</div>${ins(r.devStrengths,'var(--dev)')}</div>
    <div class="ins-box"><div class="ins-box-title">üñ• Dev ‚Äî Improve</div>${ins(r.devImprove,'var(--red)')}</div>
    <div class="ins-box"><div class="ins-box-title">üì¶ PM ‚Äî Strengths</div>${ins(r.pmStrengths,'var(--pm)')}</div>
    <div class="ins-box"><div class="ins-box-title">üì¶ PM ‚Äî Improve</div>${ins(r.pmImprove,'var(--red)')}</div>
    <div class="ins-box"><div class="ins-box-title">üìö Top Learnings</div>${ins(r.topLearnings,'var(--gold)')}</div>
    <div class="ins-box"><div class="ins-box-title">‚ö†Ô∏è Blind Spots</div>${ins(r.blindSpots,'var(--pm)')}</div>
  </div>
  <div class="ins-box" style="margin-top:13px">
    <div class="ins-box-title">üéØ Next Month Goals</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(175px,1fr));gap:9px;margin-top:8px">
      ${(r.nextMonthGoals||[]).map((g,i)=>`<div style="display:flex;gap:8px;align-items:flex-start;font-size:13px;line-height:1.6"><span style="font-family:DM Mono,monospace;font-weight:600;color:var(--dev);min-width:20px">0${i+1}</span><span>${g}</span></div>`).join('')}
    </div>
  </div>
  <hr class="rc-divider">
  <div>
    <div style="font-family:Playfair Display,serif;font-size:19px;font-weight:800;margin-bottom:14px">Self Reflections <span class="badge badge-self" style="font-size:9px;vertical-align:middle">Your Words</span></div>
    <div class="manual-grid">
      <div class="field"><label>What am I most proud of?</label><textarea id="rfl_proud" placeholder="Be specific...">${ref.proud||''}</textarea></div>
      <div class="field"><label>Biggest challenge this month</label><textarea id="rfl_challenge" placeholder="Be honest...">${ref.challenge||''}</textarea></div>
      <div class="field"><label>As a developer, I must focus on‚Ä¶</label><textarea id="rfl_dev" placeholder="Skill, habit, tool...">${ref.dev||''}</textarea></div>
      <div class="field"><label>As a PM thinker, I need to‚Ä¶</label><textarea id="rfl_pm" placeholder="User thinking, prioritization...">${ref.pm||''}</textarea></div>
      <div class="field manual-full"><label>Note to myself for next month</label><textarea id="rfl_note" style="min-height:60px" placeholder="Anything to remember...">${ref.note||''}</textarea></div>
      <div class="field"><label>Satisfaction this month</label>
        <div class="star-row" id="starRow">${[1,2,3,4,5].map(n=>`<button class="star-btn ${(ref.rating||0)>=n?'on':''}" onclick="setStar(${n})">‚òÖ</button>`).join('')}</div>
      </div>
      <div class="field"><label>Would I share this report?</label>
        <select id="rfl_share">
          <option value="">Choose...</option>
          <option value="yes" ${ref.share==='yes'?'selected':''}>Yes ‚Äî I'm proud of it</option>
          <option value="maybe" ${ref.share==='maybe'?'selected':''}>Maybe ‚Äî if asked</option>
          <option value="no" ${ref.share==='no'?'selected':''}>Not yet ‚Äî still growing</option>
        </select>
      </div>
    </div>
  </div>
</div>`;
}

function setStar(n) { currentRating=n; document.querySelectorAll('.star-btn').forEach((b,i)=>b.classList.toggle('on',i<n)); }

function saveReflections() {
  const m=currentReportMonth; if(!m) return;
  reflections[m] = {
    proud:document.getElementById('rfl_proud')?.value||'',
    challenge:document.getElementById('rfl_challenge')?.value||'',
    dev:document.getElementById('rfl_dev')?.value||'',
    pm:document.getElementById('rfl_pm')?.value||'',
    note:document.getElementById('rfl_note')?.value||'',
    rating:currentRating,
    share:document.getElementById('rfl_share')?.value||'',
    saved:new Date().toISOString()
  };
  saveReflStore(); toast('Reflections saved!','ok');
}

function exportReport() {
  const m=currentReportMonth; const r=currentReport;
  if(!m||!r) { toast('Generate a report first','err'); return; }
  const mp = m.split('::')[0];
  const label = new Date(mp+'-02').toLocaleString('default',{month:'long',year:'numeric'});
  const ref = reflections[m]||{};
  const me = (() => {
    const parts=m.split('::'); let l=entries.filter(e=>e.month===parts[0]);
    if(parts[1]) l=l.filter(e=>e.sheetId===parts[1]); return l;
  })();
  const lines = [
    `FOOTPRINT MONTHLY REPORT ‚Äî ${label}`, '='.repeat(52), '',
    `OVERALL: ${r.overallGrade}  |  Dev: ${r.devGrade}  |  PM: ${r.pmGrade}  |  Consistency: ${r.consistencyGrade}`,
    '', 'EXECUTIVE SUMMARY', r.executiveSummary, '', `"${r.oneThingToRemember}"`,
    '', '‚îÄ'.repeat(52),
    'DEV STRENGTHS', ...(r.devStrengths||[]).map((s,i)=>`  ${i+1}. ${s}`),
    '', 'DEV ‚Äî IMPROVE', ...(r.devImprove||[]).map((s,i)=>`  ${i+1}. ${s}`),
    '', 'PM STRENGTHS', ...(r.pmStrengths||[]).map((s,i)=>`  ${i+1}. ${s}`),
    '', 'PM ‚Äî IMPROVE', ...(r.pmImprove||[]).map((s,i)=>`  ${i+1}. ${s}`),
    '', 'LEARNINGS', ...(r.topLearnings||[]).filter(Boolean).map((s,i)=>`  ${i+1}. ${s}`),
    '', 'BLIND SPOTS', ...(r.blindSpots||[]).map((s,i)=>`  ${i+1}. ${s}`),
    '', 'NEXT MONTH GOALS', ...(r.nextMonthGoals||[]).map((s,i)=>`  0${i+1}. ${s}`),
    '', '‚îÄ'.repeat(52), 'SELF REFLECTIONS', '',
    `Most proud of : ${ref.proud||'‚Äî'}`, `Challenge     : ${ref.challenge||'‚Äî'}`,
    `Dev focus     : ${ref.dev||'‚Äî'}`,   `PM mindset    : ${ref.pm||'‚Äî'}`,
    `Note to self  : ${ref.note||'‚Äî'}`,
    `Satisfaction  : ${'‚òÖ'.repeat(ref.rating||0)}${'‚òÜ'.repeat(5-(ref.rating||0))}`,
    `Would share?  : ${ref.share||'‚Äî'}`,
    '', '‚îÄ'.repeat(52), 'ALL ENTRIES',
    ...me.map(e=>`[${e.date}] [${e.sheetName||'‚Äî'}] ${e.title} | ${(e.cats||[]).join(',')} | ${e.impact}`),
    '', `Generated by Footprint Growth Portal ¬∑ ${new Date().toLocaleDateString()}`
  ].join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([lines],{type:'text/plain'}));
  a.download=`footprint-${mp}.txt`; a.click();
  toast('Report exported!','ok');
}

function deleteReport() {
  const m=currentReportMonth; if(!m) return;
  const label=new Date(m.split('::')[0]+'-02').toLocaleString('default',{month:'long',year:'numeric'});
  if(!confirm(`Delete the report & reflections for ${label}?\n\nTask entries will NOT be deleted.`)) return;
  delete reflections[m]; saveReflStore();
  currentReport=null; currentReportMonth=null; currentRating=0;
  document.getElementById('reportOut').innerHTML='';
  ['saveReflBtn','exportRptBtn','deleteRptBtn'].forEach(id=>document.getElementById(id).style.display='none');
  toast('Report deleted','ok');
}
</script>
</body>
</html>
