<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Footprint ‚Äî Growth Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0e0e14;
  --paper: #f5f2ed;
  --paper2: #ede9e1;
  --rule: #d9d3c8;
  --dev: #1a4d3e;
  --dev-light: #e8f4f0;
  --pm: #5c1a00;
  --pm-light: #fdf0e8;
  --gold: #c8973a;
  --gold-light: #fdf6e8;
  --red: #c0392b;
  --text: #1a1a24;
  --muted: #7a7065;
  --shadow: rgba(14,14,20,0.08);
  --sync-pull: #1565c0;
  --sync-pull-light: #e3f0fd;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--paper); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; }
body::before {
  content: ''; position: fixed; inset: 0; z-index: 0;
  background-image: repeating-linear-gradient(transparent, transparent 27px, rgba(180,160,130,0.15) 27px, rgba(180,160,130,0.15) 28px);
  pointer-events: none;
}
body::after {
  content: ''; position: fixed; top: 0; bottom: 0; left: 68px; z-index: 0;
  width: 1px; background: rgba(200,151,58,0.2); pointer-events: none;
}
.wrap { position: relative; z-index: 1; max-width: 1020px; margin: 0 auto; padding: 32px 24px 100px; }

/* HEADER */
.top-bar { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 32px; padding-bottom: 18px; border-bottom: 2px solid var(--ink); flex-wrap: wrap; gap: 14px; }
.logo { font-family: 'Playfair Display', serif; font-weight: 900; font-size: 38px; line-height: 1; letter-spacing: -1.5px; }
.logo em { font-style: italic; color: var(--dev); }
.logo-sub { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 3px; color: var(--muted); margin-top: 4px; }
.header-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
.current-date { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); }

/* SHEET SWITCHER */
.sheet-switcher { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
.sh-tab {
  display: flex; align-items: center; gap: 5px;
  font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.3px;
  padding: 5px 11px; border-radius: 4px; cursor: pointer;
  border: 1.5px solid var(--rule); background: #fff; color: var(--muted);
  transition: all 0.15s;
}
.sh-tab.active { color: var(--ink); border-color: var(--ink); background: var(--paper); font-weight: 600; }
.sh-tab:hover:not(.active) { border-color: var(--muted); color: var(--text); }
.sh-cdot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.sh-sdot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.sh-sdot.ok { background: #27ae60; } .sh-sdot.off { background: #ccc; }
.btn-add-sheet { font-family: 'DM Mono', monospace; font-size: 12px; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: 1.5px dashed var(--rule); background: transparent; color: var(--muted); transition: all 0.15s; }
.btn-add-sheet:hover { border-color: var(--dev); color: var(--dev); }
.btn-mgr { font-family: 'DM Mono', monospace; font-size: 10px; padding: 5px 9px; border-radius: 4px; cursor: pointer; border: 1.5px solid var(--rule); background: transparent; color: var(--muted); transition: all 0.15s; letter-spacing: 0.5px; }
.btn-mgr:hover { border-color: var(--gold); color: var(--gold); }

/* TABS */
.tabs { display: flex; gap: 0; margin-bottom: 26px; border-bottom: 2px solid var(--ink); }
.tab { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 14px; padding: 10px 22px 12px; cursor: pointer; border: none; background: transparent; color: var(--muted); border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
.tab.active { color: var(--ink); border-bottom-color: var(--ink); }
.tab:hover:not(.active) { color: var(--text); }

/* ACTIVE SHEET BAR */
.active-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding: 10px 16px; background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; font-size: 13px; flex-wrap: wrap; }
.active-bar .sh-cdot { width: 10px; height: 10px; }
.ab-name { font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 500; }
.ab-info { font-size: 11px; color: var(--muted); font-family: 'DM Mono', monospace; margin-left: auto; }
.ab-status { display: flex; align-items: center; gap: 5px; font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); }

/* SYNC PULL BANNER */
.sync-banner {
  display: none; align-items: center; gap: 10px; margin-bottom: 16px;
  padding: 10px 16px; background: var(--sync-pull-light);
  border: 1.5px solid rgba(21,101,192,0.3); border-radius: 6px;
  font-family: 'DM Mono', monospace; font-size: 12px; color: var(--sync-pull);
  animation: pulseIn 0.3s ease;
}
.sync-banner.visible { display: flex; }
@keyframes pulseIn { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:translateY(0)} }
.sync-banner-icon { font-size: 16px; flex-shrink: 0; }
.sync-banner-txt { flex: 1; }
.sync-banner-txt strong { display: block; margin-bottom: 2px; }
.sync-banner-txt span { font-size: 10px; color: rgba(21,101,192,0.7); }
.sync-banner-actions { display: flex; gap: 6px; flex-shrink: 0; }
.btn-pull { font-family: 'DM Mono', monospace; font-size: 10px; font-weight: 600; padding: 5px 12px; border-radius: 4px; cursor: pointer; border: 1.5px solid var(--sync-pull); background: var(--sync-pull); color: #fff; letter-spacing: 0.5px; transition: all 0.15s; }
.btn-pull:hover { opacity: 0.85; }
.btn-pull-dismiss { font-family: 'DM Mono', monospace; font-size: 10px; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: 1.5px solid rgba(21,101,192,0.3); background: transparent; color: var(--sync-pull); transition: all 0.15s; }
.btn-pull-dismiss:hover { background: rgba(21,101,192,0.08); }

/* SYNC STATUS INDICATOR */
.sync-status-row {
  display: flex; align-items: center; gap: 8px; margin-bottom: 12px;
  font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted);
}
.sync-pulse { width: 8px; height: 8px; border-radius: 50%; background: #ccc; flex-shrink: 0; }
.sync-pulse.active { background: #27ae60; animation: blink 2s ease-in-out infinite; }
.sync-pulse.syncing { background: var(--gold); animation: blink 0.5s ease-in-out infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* FORMS */
.log-card { background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; padding: 24px 28px; margin-bottom: 20px; box-shadow: 0 2px 10px var(--shadow); }
.section-label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 3px; color: var(--muted); text-transform: uppercase; margin-bottom: 16px; padding-bottom: 6px; border-bottom: 1px solid var(--rule); }
.frow { display: grid; gap: 14px; margin-bottom: 16px; }
.frow.c2 { grid-template-columns: 190px 1fr; }
.frow.c3 { grid-template-columns: 170px 1fr 150px; }
@media(max-width:640px){ .frow.c2,.frow.c3 { grid-template-columns: 1fr; } }
.field label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; display: block; margin-bottom: 6px; }
input[type=text],input[type=date],input[type=month],input[type=number],textarea,select {
  width: 100%; background: #fff; border: 1.5px solid var(--rule); color: var(--text);
  padding: 9px 13px; border-radius: 4px; font-family: 'DM Sans', sans-serif; font-size: 14px;
  outline: none; transition: border-color 0.2s; -webkit-appearance: none;
}
input:focus, textarea:focus, select:focus { border-color: var(--dev); }
textarea { resize: vertical; min-height: 80px; line-height: 1.6; }

/* Chips */
.cats-wrap { display: flex; gap: 7px; flex-wrap: wrap; }
.cat-chip { font-family: 'DM Mono', monospace; font-size: 11px; padding: 5px 13px; border-radius: 3px; cursor: pointer; user-select: none; border: 1.5px solid var(--rule); color: var(--muted); background: #fff; transition: all 0.15s; }
.cat-chip:hover { border-color: var(--dev); color: var(--dev); }
.cat-chip.sel-dev   { background: var(--dev);  color: #fff; border-color: var(--dev); }
.cat-chip.sel-pm    { background: var(--pm);   color: #fff; border-color: var(--pm); }
.cat-chip.sel-learn { background: var(--gold); color: #fff; border-color: var(--gold); }
.cat-chip.sel-other { background: var(--ink);  color: #fff; border-color: var(--ink); }

/* Buttons */
.btn { font-family: 'DM Mono', monospace; font-weight: 500; font-size: 11px; padding: 10px 22px; border-radius: 4px; cursor: pointer; border: 1.5px solid; letter-spacing: 1px; text-transform: uppercase; transition: all 0.18s; white-space: nowrap; }
.btn-primary { background: var(--ink); color: var(--paper); border-color: var(--ink); }
.btn-primary:hover { background: var(--dev); border-color: var(--dev); }
.btn-gold { background: var(--gold); color: #fff; border-color: var(--gold); }
.btn-gold:hover { opacity: 0.85; }
.btn-outline { background: transparent; color: var(--text); border-color: var(--rule); }
.btn-outline:hover { border-color: var(--text); }
.btn-danger { background: transparent; color: var(--red); border-color: #e9b4b4; }
.btn-danger:hover { background: #fdecea; }
.btn-sm { font-size: 10px; padding: 5px 10px; }
.btn-edit { background: transparent; color: var(--dev); border-color: #a8d8c8; font-size: 10px; padding: 5px 10px; }
.btn-sync-now { background: var(--sync-pull-light); color: var(--sync-pull); border-color: rgba(21,101,192,0.35); font-size: 10px; padding: 5px 11px; }
.btn-sync-now:hover { background: rgba(21,101,192,0.12); }
.btn-row { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; align-items: center; }
.save-hint { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); }

/* FILTER BAR */
.filter-bar { background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; padding: 14px 18px; margin-bottom: 16px; display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
.filter-bar .field { flex: 1; min-width: 110px; }

/* DAY GROUPS */
.day-group { margin-bottom: 20px; }
.day-header { display: flex; align-items: center; gap: 10px; margin-bottom: 9px; padding-bottom: 7px; border-bottom: 1px solid var(--rule); }
.day-date-label { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 16px; }
.day-dow { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; }
.day-cat-pills { display: flex; gap: 4px; flex-wrap: wrap; margin-left: auto; }
.day-pill { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px; text-transform: uppercase; padding: 2px 8px; border-radius: 10px; }
.pill-dev { background: var(--dev-light); color: var(--dev); }
.pill-pm  { background: var(--pm-light);  color: var(--pm); }
.pill-learn { background: var(--gold-light); color: var(--gold); }
.pill-review,.pill-design,.pill-infra,.pill-collab,.pill-bug,.pill-meeting,.pill-other { background: var(--paper2); color: var(--muted); }
.day-hrs { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); }

/* ENTRY */
.entry { background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; padding: 14px 17px; margin-bottom: 6px; border-left: 4px solid var(--rule); transition: box-shadow 0.18s; animation: up 0.2s ease both; }
@keyframes up { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
.entry:hover { box-shadow: 0 3px 12px var(--shadow); }
.entry.t-dev   { border-left-color: var(--dev); }
.entry.t-pm    { border-left-color: var(--pm); }
.entry.t-learn { border-left-color: var(--gold); }
.entry.t-sheet-modified { border-left-color: var(--sync-pull); background: #fafcff; }
.entry-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
.entry-title { font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 700; margin-bottom: 3px; }
.entry-desc { font-size: 13px; color: var(--muted); line-height: 1.6; margin-bottom: 7px; }
.entry-chips { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
.chip { font-family: 'DM Mono', monospace; font-size: 9px; padding: 2px 7px; border-radius: 2px; letter-spacing: 0.5px; text-transform: uppercase; }
.chip-dev   { background: var(--dev-light); color: var(--dev); }
.chip-pm    { background: var(--pm-light);  color: var(--pm); }
.chip-learn { background: var(--gold-light); color: var(--gold); }
.chip-other { background: var(--paper2); color: var(--muted); }
.chip-hi  { background: #fdecea; color: var(--red); }
.chip-med { background: #e8f5e9; color: #2e7d32; }
.chip-lo  { background: var(--paper2); color: var(--muted); }
.chip-sheet-src { background: var(--sync-pull-light); color: var(--sync-pull); }
.entry-outcome { margin-top: 7px; padding: 5px 9px; background: var(--dev-light); border-radius: 3px; font-size: 11px; color: var(--dev); font-family: 'DM Mono', monospace; }
.entry-outcome::before { content: '‚Üí '; }
.entry-actions { display: flex; gap: 4px; align-items: center; flex-shrink: 0; }
.sync-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; margin-left: 3px; }
.sync-dot.ok   { background: #27ae60; } .sync-dot.pend { background: var(--gold); }
.sync-dot.sheet { background: var(--sync-pull); }
.empty { text-align: center; padding: 56px 20px; color: var(--muted); }
.empty-icon { font-size: 32px; margin-bottom: 10px; }
.empty h3 { font-family: 'Playfair Display', serif; font-size: 19px; color: var(--text); margin-bottom: 5px; }

/* MODALS shared */
.modal-backdrop { position: fixed; inset: 0; background: rgba(14,14,20,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.modal-backdrop.open { opacity: 1; pointer-events: all; }
.modal { background: var(--paper); border: 1.5px solid var(--rule); border-radius: 8px; padding: 26px 28px; width: 100%; max-height: 90vh; overflow-y: auto; transform: translateY(14px); transition: transform 0.2s; box-shadow: 0 16px 48px rgba(14,14,20,0.2); }
.modal-backdrop.open .modal { transform: translateY(0); }
.modal-lg { max-width: 700px; }
.modal-sm { max-width: 620px; }
.modal-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-title { font-family: 'Playfair Display', serif; font-size: 21px; font-weight: 800; }
.modal-close { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--muted); padding: 0 4px; line-height: 1; }

/* CONFLICT MODAL */
.conflict-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; font-size: 13px; }
.conflict-side { border: 1.5px solid var(--rule); border-radius: 6px; padding: 12px 14px; }
.conflict-side.local { border-color: var(--gold); background: var(--gold-light); }
.conflict-side.remote { border-color: var(--sync-pull); background: var(--sync-pull-light); }
.conflict-label { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 7px; }
.conflict-label.l { color: var(--gold); }
.conflict-label.r { color: var(--sync-pull); }
.conflict-field { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
.conflict-val { font-size: 13px; color: var(--text); font-weight: 500; }

/* SHEET LIST in manage modal */
.sheet-list-item { display: flex; align-items: center; gap: 12px; padding: 13px 16px; background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; margin-bottom: 8px; transition: all 0.15s; }
.sheet-list-item.is-active { border-color: var(--dev); }
.sheet-list-item:hover { box-shadow: 0 2px 8px var(--shadow); }
.sli-name { font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 14px; flex: 1; }
.sli-id   { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); }
.sli-count { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); white-space: nowrap; }
.sli-actions { display: flex; gap: 6px; flex-shrink: 0; }
.active-badge { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px; text-transform: uppercase; padding: 2px 7px; border-radius: 2px; background: var(--dev-light); color: var(--dev); }
.add-form { background: var(--gold-light); border: 1.5px solid var(--gold); border-radius: 6px; padding: 18px 20px; margin-top: 18px; }
.add-form h4 { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 700; margin-bottom: 12px; }
.add-form p { font-size: 12px; color: var(--muted); margin-bottom: 12px; line-height: 1.7; }
.add-form code { font-family: 'DM Mono', monospace; font-size: 11px; background: rgba(200,151,58,0.18); padding: 1px 5px; border-radius: 3px; color: var(--pm); }

/* Sync settings in manage modal */
.sync-settings { background: var(--sync-pull-light); border: 1.5px solid rgba(21,101,192,0.25); border-radius: 6px; padding: 16px 18px; margin-top: 14px; }
.sync-settings h4 { font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 700; margin-bottom: 10px; color: var(--sync-pull); }
.sync-opt-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 10px; flex-wrap: wrap; }
.sync-opt-label { font-size: 13px; }
.sync-opt-label small { display: block; font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); margin-top: 2px; }
.toggle-wrap { display: flex; gap: 6px; flex-shrink: 0; }
.toggle-btn { font-family: 'DM Mono', monospace; font-size: 10px; padding: 4px 10px; border-radius: 3px; cursor: pointer; border: 1.5px solid var(--rule); background: #fff; color: var(--muted); transition: all 0.15s; }
.toggle-btn.on { background: var(--sync-pull); color: #fff; border-color: var(--sync-pull); }

/* Color swatches */
.swatches { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
.swatch { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2.5px solid transparent; transition: all 0.15s; }
.swatch.sel { border-color: var(--ink); transform: scale(1.18); }
.swatch:hover:not(.sel) { transform: scale(1.1); }

/* API setup section */
.api-section { border-top: 1px solid var(--rule); padding-top: 18px; margin-top: 16px; }

/* REPORT */
.report-card { background: #fff; border: 1.5px solid var(--rule); border-radius: 6px; padding: 28px 32px; box-shadow: 0 2px 14px var(--shadow); }
.rc-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 16px; border-bottom: 2px solid var(--ink); margin-bottom: 22px; flex-wrap: wrap; gap: 10px; }
.rc-title { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 900; letter-spacing: -0.5px; }
.rc-month { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); margin-top: 3px; }
.rc-stamp { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 900; color: var(--dev); border: 3px solid var(--dev); border-radius: 4px; padding: 2px 11px; transform: rotate(-3deg); opacity: 0.85; text-transform: uppercase; letter-spacing: 1px; }
.grade-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 22px; }
@media(max-width:580px){ .grade-grid { grid-template-columns: repeat(2,1fr); } }
.grade-box { border: 1.5px solid var(--rule); border-radius: 6px; padding: 12px; text-align: center; }
.grade-letter { font-family: 'Playfair Display', serif; font-size: 44px; font-weight: 900; line-height: 1; }
.grade-A { color: var(--dev); } .grade-B { color: #1565c0; } .grade-C { color: var(--gold); } .grade-D { color: var(--red); }
.grade-lbl { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; margin-top: 4px; }
.grade-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }
.stat-strip { display: grid; grid-template-columns: repeat(auto-fit,minmax(95px,1fr)); gap: 10px; margin-bottom: 22px; }
.stat-item { border-left: 3px solid var(--rule); padding: 5px 9px; }
.stat-num { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 900; }
.stat-lbl { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px; color: var(--muted); text-transform: uppercase; }
.act-dots { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 7px; }
.act-dot { width: 19px; height: 19px; border-radius: 3px; position: relative; cursor: default; }
.act-dot:hover::after { content: attr(data-tip); position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); background: var(--ink); color: #fff; font-family: 'DM Mono', monospace; font-size: 9px; padding: 3px 6px; border-radius: 3px; white-space: nowrap; z-index: 10; }
.a-empty { background: var(--paper2); border: 1px solid var(--rule); }
.a-dev   { background: var(--dev);  opacity: 0.72; }
.a-pm    { background: var(--pm);   opacity: 0.72; }
.a-both  { background: linear-gradient(135deg, var(--dev), var(--pm)); opacity: 0.8; }
.a-learn { background: var(--gold); opacity: 0.72; }
.ins-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
@media(max-width:600px){ .ins-grid { grid-template-columns: 1fr; } }
.ins-box { border: 1.5px solid var(--rule); border-radius: 6px; padding: 14px 16px; }
.ins-box-title { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 10px; }
.ins-item { display: flex; gap: 8px; font-size: 13px; line-height: 1.6; margin-bottom: 7px; }
.ins-item:last-child { margin-bottom: 0; }
.ins-dot { width: 5px; height: 5px; border-radius: 50%; margin-top: 7px; flex-shrink: 0; }
.summary-box { background: var(--dev-light); border: 1.5px solid rgba(26,77,62,0.18); border-radius: 6px; padding: 14px 18px; margin-bottom: 20px; }
.rc-divider { border: none; border-top: 2px dashed var(--rule); margin: 24px 0; }
.manual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 13px; }
@media(max-width:580px){ .manual-grid { grid-template-columns: 1fr; } }
.manual-full { grid-column: 1/-1; }
.star-row { display: flex; gap: 5px; margin-top: 6px; }
.star-btn { background: none; border: none; font-size: 21px; cursor: pointer; color: var(--rule); transition: color 0.1s; }
.star-btn.on { color: var(--gold); }
.badge { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 2px; padding: 2px 7px; border-radius: 2px; text-transform: uppercase; }
.badge-ai   { background: var(--dev-light); color: var(--dev); }
.badge-self { background: var(--pm-light);  color: var(--pm); }

/* TOAST */
.toast { position: fixed; bottom: 20px; right: 20px; z-index: 999; background: var(--ink); color: var(--paper); font-family: 'DM Mono', monospace; font-size: 12px; letter-spacing: 0.5px; padding: 10px 17px; border-radius: 4px; transform: translateY(70px); opacity: 0; transition: all 0.27s; box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
.toast.show { transform: translateY(0); opacity: 1; }
.toast.ok  { background: var(--dev); }
.toast.err { background: var(--red); }
.toast.info { background: var(--sync-pull); }
.panel { display: none; } .panel.active { display: block; }
.spin { width: 32px; height: 32px; border: 3px solid var(--rule); border-top-color: var(--dev); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px; }
@keyframes spin { to{transform:rotate(360deg)} }
.loading-wrap { text-align: center; padding: 42px 20px; }
.loading-txt { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--muted); }
.loading-txt::after { content: '...'; animation: ell 1.5s infinite; }
@keyframes ell { 0%{content:'.'} 33%{content:'..'} 66%{content:'...'} }

/* Last sync time */
.last-sync-info { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); }
</style>
</head>
<body>
<div class="wrap">

<!-- HEADER -->
<header class="top-bar">
  <div>
    <div class="logo">Foot<em>print</em></div>
    <div class="logo-sub">Growth Portal ¬∑ Dev &amp; PM</div>
  </div>
  <div class="header-right">
    <div class="current-date" id="dateDisp"></div>
    <div class="sheet-switcher" id="sheetSwitcher"></div>
  </div>
</header>

<!-- TABS -->
<div class="tabs">
  <button class="tab active" onclick="gotoTab('log',this)">üìù Log Task</button>
  <button class="tab" onclick="gotoTab('history',this)">üìã History</button>
  <button class="tab" onclick="gotoTab('report',this)">üìä Report Card</button>
</div>

<!-- LOG PANEL -->
<div id="panel-log" class="panel active">
  <div id="logBar" class="active-bar" style="display:none"></div>

  <!-- Sync changes banner (shown when sheet has new/modified rows) -->
  <div class="sync-banner" id="syncBanner">
    <div class="sync-banner-icon">üîÑ</div>
    <div class="sync-banner-txt">
      <strong id="syncBannerTitle">Changes detected in Google Sheet</strong>
      <span id="syncBannerSub">New or edited rows found that aren't in your local app yet.</span>
    </div>
    <div class="sync-banner-actions">
      <button class="btn-pull" onclick="applySheetChanges()">‚Üì Pull Changes</button>
      <button class="btn-pull-dismiss" onclick="dismissSyncBanner()">Dismiss</button>
    </div>
  </div>

  <div class="log-card">
    <div class="section-label">New Entry</div>
    <div class="frow c2">
      <div class="field"><label>Date</label><input type="date" id="fDate"></div>
      <div class="field"><label>Task Title</label><input type="text" id="fTitle" placeholder="What did you work on?"></div>
    </div>
    <div class="frow">
      <div class="field"><label>Description</label>
        <textarea id="fDesc" placeholder="Describe what you built, decided, reviewed, or learned. More detail ‚Üí better AI report."></textarea>
      </div>
    </div>
    <div class="frow c3">
      <div class="field"><label>Impact</label>
        <select id="fImpact">
          <option value="low">üü° Low ‚Äî Routine</option>
          <option value="medium" selected>üü¢ Medium ‚Äî Meaningful</option>
          <option value="high">üî¥ High ‚Äî Milestone</option>
        </select>
      </div>
      <div class="field"><label>Key Outcome / Learning</label><input type="text" id="fOutcome" placeholder="What did you learn or ship?"></div>
      <div class="field"><label>Effort (hrs)</label><input type="number" id="fEffort" placeholder="2.5" min="0" step="0.5"></div>
    </div>
    <div class="field">
      <label>Categories</label>
      <div class="cats-wrap" id="logCats">
        <div class="cat-chip" data-cat="dev"     data-sel="dev"   onclick="toggleCat(this)">üñ• Dev</div>
        <div class="cat-chip" data-cat="pm"      data-sel="pm"    onclick="toggleCat(this)">üì¶ PM</div>
        <div class="cat-chip" data-cat="learn"   data-sel="learn" onclick="toggleCat(this)">üìö Learning</div>
        <div class="cat-chip" data-cat="review"  data-sel="other" onclick="toggleCat(this)">üîç Review</div>
        <div class="cat-chip" data-cat="design"  data-sel="other" onclick="toggleCat(this)">üé® Design</div>
        <div class="cat-chip" data-cat="infra"   data-sel="other" onclick="toggleCat(this)">‚öôÔ∏è Infra</div>
        <div class="cat-chip" data-cat="collab"  data-sel="other" onclick="toggleCat(this)">ü§ù Collab</div>
        <div class="cat-chip" data-cat="bug"     data-sel="other" onclick="toggleCat(this)">üêõ Bug Fix</div>
        <div class="cat-chip" data-cat="meeting" data-sel="other" onclick="toggleCat(this)">üó£ Meeting</div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="addEntry()">+ Add Entry</button>
      <button class="btn btn-outline" onclick="clearForm()">Clear</button>
      <button class="btn btn-sync-now" id="btnSyncNow" onclick="checkSheetChanges(true)" style="display:none">‚Üì Check Sheet</button>
      <span class="save-hint" id="saveHint"></span>
      <span class="last-sync-info" id="lastSyncInfo"></span>
    </div>
  </div>
</div>

<!-- HISTORY PANEL -->
<div id="panel-history" class="panel">
  <div class="filter-bar">
    <div class="field"><label>Month</label><input type="month" id="fMonth" onchange="renderHistory()"></div>
    <div class="field"><label>Sheet</label>
      <select id="fSheetH" onchange="renderHistory()">
        <option value="">All Sheets</option>
      </select>
    </div>
    <div class="field"><label>Category</label>
      <select id="fCat" onchange="renderHistory()">
        <option value="">All</option>
        <option value="dev">Dev</option><option value="pm">PM</option>
        <option value="learn">Learning</option><option value="review">Review</option>
        <option value="design">Design</option><option value="infra">Infra</option>
        <option value="collab">Collab</option><option value="bug">Bug Fix</option><option value="meeting">Meeting</option>
      </select>
    </div>
    <div class="field"><label>Impact</label>
      <select id="fImpH" onchange="renderHistory()">
        <option value="">All</option>
        <option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option>
      </select>
    </div>
    <div style="align-self:flex-end;display:flex;gap:7px">
      <button class="btn btn-outline btn-sm" id="syncBtn" onclick="syncAllPending()" style="display:none">‚Üë Push Pending</button>
      <button class="btn btn-sync-now btn-sm" id="histPullBtn" onclick="checkSheetChanges(true)" style="display:none">‚Üì Pull Sheet</button>
    </div>
    <div style="align-self:flex-end;font-family:DM Mono,monospace;font-size:11px;color:var(--muted);padding-bottom:2px" id="histCount"></div>
  </div>
  <div id="histList"></div>
</div>

<!-- REPORT PANEL -->
<div id="panel-report" class="panel">
  <div class="log-card" style="margin-bottom:20px">
    <div class="section-label">Generate Report</div>
    <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
      <div class="field"><label>Month</label><input type="month" id="rMonth"></div>
      <div class="field"><label>Filter by Sheet</label>
        <select id="fSheetR">
          <option value="">All Sheets</option>
        </select>
      </div>
      <button class="btn btn-gold" onclick="generateReport()">‚ú® Generate AI Report</button>
      <button class="btn btn-outline" id="saveReflBtn" onclick="saveReflections()" style="display:none">üíæ Save Reflections</button>
      <button class="btn btn-outline" id="exportRptBtn" onclick="exportPDF()" style="display:none">‚¨áÔ∏è Export PDF</button>
      <button class="btn btn-danger" id="deleteRptBtn" onclick="deleteReport()" style="display:none;font-size:11px;padding:10px 18px">üóë Delete</button>
    </div>
  </div>
  <div id="reportOut"></div>
</div>

</div><!-- /wrap -->

<!-- MANAGE SHEETS MODAL -->
<div class="modal-backdrop" id="mgModal" onclick="closeBgMg(event)">
  <div class="modal modal-lg">
    <div class="modal-hdr">
      <div class="modal-title">Manage Sheets</div>
      <button class="modal-close" onclick="closeMgModal()">√ó</button>
    </div>
    <div id="sheetListEl"></div>

    <!-- ‚îÄ‚îÄ SHEET SYNC SETTINGS ‚îÄ‚îÄ -->
    <div class="sync-settings" id="syncSettingsBox">
      <h4>üîÑ Two-Way Sync Settings</h4>
      <div class="sync-opt-row">
        <div class="sync-opt-label">
          Auto-check for sheet changes
          <small>Polls your Google Sheet at a set interval and notifies you when rows are added or edited directly in the sheet</small>
        </div>
        <div class="toggle-wrap">
          <button class="toggle-btn" id="autoSyncToggle" onclick="toggleAutoSync()">OFF</button>
        </div>
      </div>
      <div class="sync-opt-row" id="intervalRow" style="display:none">
        <div class="sync-opt-label">
          Poll interval
          <small>How often to check the Google Sheet for changes</small>
        </div>
        <div class="field" style="max-width:150px;margin:0">
          <select id="pollInterval" onchange="saveSyncSettings()">
            <option value="30000">Every 30 sec</option>
            <option value="60000" selected>Every 1 min</option>
            <option value="120000">Every 2 min</option>
            <option value="300000">Every 5 min</option>
          </select>
        </div>
      </div>
      <div class="sync-opt-row">
        <div class="sync-opt-label">
          Conflict resolution strategy
          <small>What to do when the same entry has been edited both locally and in the sheet</small>
        </div>
        <div class="toggle-wrap">
          <button class="toggle-btn ${cfg.syncConflict==='sheet'?'on':''}" id="conflictLocal" onclick="setConflict('local')"  style="font-size:9px">Keep Local</button>
          <button class="toggle-btn ${cfg.syncConflict==='sheet'?'on':''}" id="conflictSheet" onclick="setConflict('sheet')"  style="font-size:9px">Keep Sheet</button>
          <button class="toggle-btn"                                        id="conflictAsk"   onclick="setConflict('ask')"    style="font-size:9px">Always Ask</button>
        </div>
      </div>
    </div>

    <div class="add-form">
      <h4>+ Connect a New Sheet</h4>
      <p>Create a blank Google Sheet, then copy its ID from the URL:<br>
        <code>docs.google.com/spreadsheets/d/<strong>SHEET_ID</strong>/edit</code>
      </p>
      <div class="frow c2" style="margin-bottom:12px">
        <div class="field"><label>Sheet Name</label><input type="text" id="nsName" placeholder="e.g. Work Projects"></div>
        <div class="field"><label>Google Sheet ID</label><input type="text" id="nsSheetId" placeholder="1BxiMVs0XRA5nFMd‚Ä¶"></div>
      </div>
      <div class="field" style="margin-bottom:14px">
        <label>Color Label</label>
        <div class="swatches" id="colorSwatches">
          <div class="swatch sel" data-color="#1a4d3e" style="background:#1a4d3e" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#5c1a00" style="background:#5c1a00" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#c8973a" style="background:#c8973a" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#1565c0" style="background:#1565c0" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#6a1b9a" style="background:#6a1b9a" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#c62828" style="background:#c62828" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#00695c" style="background:#00695c" onclick="pickColor(this)"></div>
          <div class="swatch" data-color="#4e342e" style="background:#4e342e" onclick="pickColor(this)"></div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="addNewSheet()">Add Sheet</button>
    </div>
    <!-- Client ID setup -->
    <div class="api-section" id="apiSection">
      <div class="section-label" style="margin-bottom:12px">Google API Connection</div>
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.7">
        Enable <code>Google Sheets API</code> in <code>console.cloud.google.com</code>, create an
        OAuth 2.0 Web Application credential, and add your site URL to Authorized JavaScript Origins.
      </p>
      <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
        <div class="field" style="flex:1;min-width:200px"><label>Google OAuth Client ID</label>
          <input type="text" id="cfgClientId" placeholder="xxxx.apps.googleusercontent.com">
        </div>
        <button class="btn btn-primary" onclick="saveClientId()">Save &amp; Connect</button>
        <div id="authStatus" style="font-family:DM Mono,monospace;font-size:11px;color:var(--muted);align-self:flex-end;padding-bottom:2px"></div>
      </div>
    </div>
  </div>
</div>

<!-- EDIT ENTRY MODAL -->
<div class="modal-backdrop" id="editModal" onclick="closeBgEdit(event)" style="z-index:100">
  <div class="modal modal-sm">
    <div class="modal-hdr">
      <div class="modal-title">Edit Entry</div>
      <button class="modal-close" onclick="closeEditModal()">√ó</button>
    </div>
    <div class="frow c2">
      <div class="field"><label>Date</label><input type="date" id="mDate"></div>
      <div class="field"><label>Task Title</label><input type="text" id="mTitle"></div>
    </div>
    <div class="frow" style="margin-bottom:14px">
      <div class="field"><label>Description</label><textarea id="mDesc" style="min-height:76px"></textarea></div>
    </div>
    <div class="frow c3">
      <div class="field"><label>Impact</label>
        <select id="mImpact">
          <option value="low">üü° Low</option>
          <option value="medium">üü¢ Medium</option>
          <option value="high">üî¥ High</option>
        </select>
      </div>
      <div class="field"><label>Outcome</label><input type="text" id="mOutcome"></div>
      <div class="field"><label>Effort (hrs)</label><input type="number" id="mEffort" min="0" step="0.5"></div>
    </div>
    <div class="field" style="margin-bottom:16px">
      <label>Categories</label>
      <div class="cats-wrap" id="modalCats">
        <div class="cat-chip" data-cat="dev"     data-sel="dev"   onclick="toggleCat(this)">üñ• Dev</div>
        <div class="cat-chip" data-cat="pm"      data-sel="pm"    onclick="toggleCat(this)">üì¶ PM</div>
        <div class="cat-chip" data-cat="learn"   data-sel="learn" onclick="toggleCat(this)">üìö Learning</div>
        <div class="cat-chip" data-cat="review"  data-sel="other" onclick="toggleCat(this)">üîç Review</div>
        <div class="cat-chip" data-cat="design"  data-sel="other" onclick="toggleCat(this)">üé® Design</div>
        <div class="cat-chip" data-cat="infra"   data-sel="other" onclick="toggleCat(this)">‚öôÔ∏è Infra</div>
        <div class="cat-chip" data-cat="collab"  data-sel="other" onclick="toggleCat(this)">ü§ù Collab</div>
        <div class="cat-chip" data-cat="bug"     data-sel="other" onclick="toggleCat(this)">üêõ Bug Fix</div>
        <div class="cat-chip" data-cat="meeting" data-sel="other" onclick="toggleCat(this)">üó£ Meeting</div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
      <button class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- CONFLICT RESOLUTION MODAL -->
<div class="modal-backdrop" id="conflictModal" style="z-index:300">
  <div class="modal modal-sm">
    <div class="modal-hdr">
      <div class="modal-title">‚ö° Sync Conflict</div>
      <button class="modal-close" onclick="resolveConflict('skip')">√ó</button>
    </div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px;line-height:1.7">
      This entry was modified both in the app and in Google Sheets. Which version should be kept?
    </p>
    <div class="conflict-row" id="conflictCompare"></div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="resolveConflict('local')">Keep Local Version</button>
      <button class="btn btn-pull" onclick="resolveConflict('sheet')">Keep Sheet Version</button>
      <button class="btn btn-outline" onclick="resolveConflict('skip')">Skip for Now</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let entries     = JSON.parse(localStorage.getItem('fp_entries') || '[]');
let cfg         = JSON.parse(localStorage.getItem('fp_cfg')     || '{"sheets":[],"activeSheetId":null,"clientId":null,"autoSync":false,"pollInterval":60000,"syncConflict":"ask"}');
let reflections = JSON.parse(localStorage.getItem('fp_refl')    || '{}');

if (!cfg.sheets)       cfg.sheets = [];
if (!cfg.pollInterval) cfg.pollInterval = 60000;
if (!cfg.syncConflict) cfg.syncConflict = 'ask';
if (cfg.autoSync === undefined) cfg.autoSync = false;

let gapiReady  = false;
let signedIn   = false;
let editingId  = null;
let newColor   = '#1a4d3e';
let currentRating = 0;
let currentReportMonth = null;
let currentReport = null;

// Pull-sync state
let pendingSheetChanges = [];  // rows fetched from sheet not yet in local
let pollTimer = null;
let lastPollTime = null;
let conflictQueue = [];
let currentConflict = null;

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function save()         { localStorage.setItem('fp_entries', JSON.stringify(entries)); }
function saveCfg()      { localStorage.setItem('fp_cfg',     JSON.stringify(cfg)); }
function saveReflStore(){ localStorage.setItem('fp_refl',    JSON.stringify(reflections)); }
function uid()          { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function activeSheet()  { return cfg.sheets.find(s => s.id === cfg.activeSheetId) || null; }
function sheetById(id)  { return cfg.sheets.find(s => s.id === id) || null; }
function toast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + type;
  setTimeout(() => t.className = 'toast', 3200);
}

const CAT_SEL = { dev:'sel-dev', pm:'sel-pm', learn:'sel-learn' };
function catSelCls(cat) { return CAT_SEL[cat] || 'sel-other'; }
function toggleCat(el) { el.classList.toggle(catSelCls(el.dataset.cat)); }
function getSelCats(cid) {
  return [...document.querySelectorAll(`#${cid} .cat-chip`)].filter(c => c.className.match(/sel-/)).map(c => c.dataset.cat);
}
function setSelCats(cid, cats) {
  document.querySelectorAll(`#${cid} .cat-chip`).forEach(c => {
    ['sel-dev','sel-pm','sel-learn','sel-other'].forEach(cl => c.classList.remove(cl));
    if ((cats||[]).includes(c.dataset.cat)) c.classList.add(catSelCls(c.dataset.cat));
  });
}

// ‚îÄ‚îÄ‚îÄ ROW ‚Üí ENTRY PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Sheet columns: Date(0) Title(1) Desc(2) Cats(3) Impact(4) Outcome(5) Effort(6) Month(7) ID(8) Created(9) SheetName(10)
function rowToEntry(row, sheetMeta) {
  const rawId = (row[8] || '').toString().trim();
  // IDs from app are numeric timestamps; rows added directly in sheet won't have one
  const id = rawId && !isNaN(rawId) ? parseInt(rawId) : null;
  const date = (row[0] || '').trim();
  const month = date.length >= 7 ? date.slice(0,7) : (row[7]||'').trim();
  return {
    id,
    _sheetRowId: rawId || null,   // keep original string for matching
    date,
    title: (row[1] || '').trim(),
    desc: (row[2] || '').trim(),
    cats: (row[3] || '').split(',').map(s=>s.trim()).filter(Boolean),
    impact: (row[4] || 'medium').trim().toLowerCase(),
    outcome: (row[5] || '').trim(),
    effort: (row[6] || '').trim(),
    month,
    synced: true,
    fromSheet: true,
    sheetId: sheetMeta.id,
    sheetName: sheetMeta.name,
    created: (row[9] || new Date().toISOString()).trim()
  };
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const now = new Date();
  document.getElementById('dateDisp').textContent = now.toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('fDate').value = now.toISOString().split('T')[0];
  const ym = now.toISOString().slice(0,7);
  ['fMonth','rMonth'].forEach(id => document.getElementById(id).value = ym);
  renderSwitcher();
  renderDropdowns();
  updateLogBar();
  applySyncSettingsUI();
  if (cfg.clientId) loadGapi();
})();

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function gotoTab(name, el) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  el.classList.add('active');
  if (name === 'history') renderHistory();
}

// ‚îÄ‚îÄ‚îÄ SHEET SWITCHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSwitcher() {
  const sw = document.getElementById('sheetSwitcher');
  let html = cfg.sheets.map(s => `
    <button class="sh-tab ${s.id===cfg.activeSheetId?'active':''}" onclick="setActive('${s.id}')">
      <span class="sh-cdot" style="background:${s.color||'#1a4d3e'}"></span>
      ${s.name}
      <span class="sh-sdot ${signedIn?'ok':'off'}" title="${signedIn?'Syncing':'Not connected'}"></span>
    </button>`).join('');
  html += `<button class="btn-add-sheet" onclick="openMgModal()">+ Sheet</button>`;
  html += `<button class="btn-mgr" onclick="openMgModal()">‚öô Manage</button>`;
  sw.innerHTML = html;
}

function setActive(id) {
  cfg.activeSheetId = id; saveCfg();
  renderSwitcher(); renderDropdowns(); updateLogBar(); renderHistory();
}

function updateLogBar() {
  const bar = document.getElementById('logBar');
  const s = activeSheet();
  const btnSyncNow = document.getElementById('btnSyncNow');
  if (!s) { bar.style.display = 'none'; if(btnSyncNow) btnSyncNow.style.display='none'; return; }
  bar.style.display = 'flex';
  if(btnSyncNow) btnSyncNow.style.display = signedIn ? '' : 'none';
  const total   = entries.filter(e => e.sheetId === s.id).length;
  const pending = entries.filter(e => e.sheetId === s.id && !e.synced).length;
  bar.innerHTML = `
    <span class="sh-cdot" style="background:${s.color};width:10px;height:10px"></span>
    <span class="ab-name">${s.name}</span>
    <span class="ab-info">${total} entries${pending?` ¬∑ ${pending} pending`:''}</span>
    <span class="ab-status">
      <span class="sh-sdot ${signedIn?'ok':'off'}"></span>
      ${signedIn?'Two-way sync active':'Not connected ‚Äî entries saved locally'}
    </span>`;
  updateLastSyncLabel();
}

function updateLastSyncLabel() {
  const el = document.getElementById('lastSyncInfo');
  if (!el) return;
  if (!lastPollTime) { el.textContent = ''; return; }
  const diff = Math.round((Date.now() - lastPollTime)/1000);
  el.textContent = `Last checked: ${diff < 60 ? diff+'s ago' : Math.round(diff/60)+'m ago'}`;
}

function renderDropdowns() {
  const opts = '<option value="">All Sheets</option>' +
    cfg.sheets.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  ['fSheetH','fSheetR'].forEach(id => {
    const el = document.getElementById(id); if (!el) return;
    const v = el.value; el.innerHTML = opts; el.value = v;
  });
}

// ‚îÄ‚îÄ‚îÄ MANAGE SHEETS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openMgModal() {
  renderSheetList();
  applySyncSettingsUI();
  if (cfg.clientId) document.getElementById('cfgClientId').value = cfg.clientId;
  document.getElementById('authStatus').textContent = signedIn ? '‚úì Connected' : cfg.clientId ? 'Connecting‚Ä¶' : '';
  document.getElementById('mgModal').classList.add('open');
}
function closeMgModal() { document.getElementById('mgModal').classList.remove('open'); }
function closeBgMg(e)   { if (e.target===document.getElementById('mgModal')) closeMgModal(); }

function renderSheetList() {
  const el = document.getElementById('sheetListEl');
  if (!cfg.sheets.length) {
    el.innerHTML = '<p style="font-size:13px;color:var(--muted);margin-bottom:16px">No sheets connected yet. Add one below.</p>';
    return;
  }
  el.innerHTML = cfg.sheets.map(s => {
    const count = entries.filter(e => e.sheetId===s.id).length;
    const isActive = s.id === cfg.activeSheetId;
    return `
    <div class="sheet-list-item ${isActive?'is-active':''}">
      <span class="sh-cdot" style="background:${s.color||'#1a4d3e'};width:14px;height:14px;flex-shrink:0"></span>
      <div style="flex:1;min-width:0">
        <div class="sli-name">${s.name} ${isActive?'<span class="active-badge">Active</span>':''}</div>
        <div class="sli-id" style="margin-top:2px">${s.sheetId ? 'ID: '+s.sheetId.slice(0,30)+'‚Ä¶' : 'No Sheet ID set'}</div>
      </div>
      <div class="sli-count">${count} entries</div>
      <div class="sli-actions">
        ${!isActive?`<button class="btn btn-outline btn-sm" onclick="setActive('${s.id}');renderSheetList()">Set Active</button>`:''}
        <button class="btn btn-danger btn-sm" onclick="removeSheet('${s.id}')">Remove</button>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ SYNC SETTINGS UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applySyncSettingsUI() {
  const autoBtn = document.getElementById('autoSyncToggle');
  if (autoBtn) {
    autoBtn.textContent = cfg.autoSync ? 'ON' : 'OFF';
    autoBtn.classList.toggle('on', cfg.autoSync);
  }
  const intRow = document.getElementById('intervalRow');
  if (intRow) intRow.style.display = cfg.autoSync ? 'flex' : 'none';
  const intEl = document.getElementById('pollInterval');
  if (intEl) intEl.value = String(cfg.pollInterval || 60000);
  // conflict buttons
  ['conflictLocal','conflictSheet','conflictAsk'].forEach(id => {
    const b = document.getElementById(id); if(!b) return;
    const strategy = {conflictLocal:'local',conflictSheet:'sheet',conflictAsk:'ask'}[id];
    b.classList.toggle('on', cfg.syncConflict === strategy);
  });
}

function toggleAutoSync() {
  cfg.autoSync = !cfg.autoSync; saveCfg();
  applySyncSettingsUI();
  if (cfg.autoSync && signedIn) startPolling();
  else stopPolling();
}

function saveSyncSettings() {
  cfg.pollInterval = parseInt(document.getElementById('pollInterval').value) || 60000;
  saveCfg();
  if (cfg.autoSync && signedIn) { stopPolling(); startPolling(); }
}

function setConflict(strategy) {
  cfg.syncConflict = strategy; saveCfg(); applySyncSettingsUI();
}

// ‚îÄ‚îÄ‚îÄ POLLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startPolling() {
  stopPolling();
  if (!cfg.autoSync || !signedIn) return;
  pollTimer = setInterval(() => checkSheetChanges(false), cfg.pollInterval);
  checkSheetChanges(false);
}

function stopPolling() {
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

// ‚îÄ‚îÄ‚îÄ CHECK SHEET FOR CHANGES (PULL) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkSheetChanges(manual = false) {
  if (!signedIn) {
    if (manual) toast('Connect to Google Sheets first','err');
    return;
  }
  const sheetsToCheck = cfg.sheets.filter(s => s.sheetId);
  if (!sheetsToCheck.length) {
    if (manual) toast('No Google Sheet connected','err');
    return;
  }

  if (manual) toast('üîÑ Checking for sheet changes‚Ä¶', 'info');

  let newRows = [], modifiedRows = [];

  for (const sh of sheetsToCheck) {
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: sh.sheetId,
        range: `${sh.tab||'Sheet1'}!A2:K`
      });
      const rows = (res.result.values || []).filter(r => r[1]); // must have a title
      for (const row of rows) {
        const rawId = (row[8]||'').toString().trim();
        const title = (row[1]||'').trim();
        const date  = (row[0]||'').trim();
        if (!title || !date) continue;

        if (rawId && !isNaN(rawId)) {
          // Row has a numeric app ID ‚Äî check if it matches a local entry
          const localEntry = entries.find(e => String(e.id) === rawId && e.sheetId === sh.id);
          if (localEntry) {
            // Compare fields to detect edits in the sheet
            if (hasSheetModified(localEntry, row)) {
              modifiedRows.push({ row, sh, localEntry });
            }
            // else: in sync, nothing to do
          } else {
            // ID exists in sheet but not locally (could have been from a different device)
            newRows.push({ row, sh });
          }
        } else {
          // No app ID ‚Äî row was added directly in the sheet
          // Check if we already imported it (match by title+date+sheet)
          // Match by title+date+sheet regardless of origin
          const alreadyImported = entries.find(e =>
            e.sheetId === sh.id &&
            e.date === date &&
            e.title.toLowerCase() === title.toLowerCase()
          );
          if (!alreadyImported) newRows.push({ row, sh });
        }
      }
    } catch(e) { console.warn('Sheet check error for', sh.name, e); }
  }

  lastPollTime = Date.now();
  updateLastSyncLabel();

  const totalChanges = newRows.length + modifiedRows.length;

  if (totalChanges === 0) {
    if (manual) toast('‚úì App is up to date with your sheets', 'ok');
    hideSyncBanner();
    return;
  }

  // Store pending changes
  pendingSheetChanges = { newRows, modifiedRows };
  showSyncBanner(newRows.length, modifiedRows.length);
}

function hasSheetModified(localEntry, row) {
  // Check if key fields differ between local and sheet row
  const shTitle   = (row[1]||'').trim();
  const shDesc    = (row[2]||'').trim();
  const shCats    = (row[3]||'').split(',').map(s=>s.trim()).filter(Boolean).sort().join(',');
  const shImpact  = (row[4]||'medium').trim().toLowerCase();
  const shOutcome = (row[5]||'').trim();
  const shEffort  = (row[6]||'').trim();
  const lcCats    = (localEntry.cats||[]).slice().sort().join(',');
  return (
    localEntry.title   !== shTitle   ||
    (localEntry.desc||'')    !== shDesc    ||
    lcCats             !== shCats    ||
    (localEntry.impact||'medium') !== shImpact  ||
    (localEntry.outcome||'') !== shOutcome ||
    String(localEntry.effort||'') !== shEffort
  );
}

function showSyncBanner(nNew, nMod) {
  const banner = document.getElementById('syncBanner');
  const title  = document.getElementById('syncBannerTitle');
  const sub    = document.getElementById('syncBannerSub');
  const parts = [];
  if (nNew)  parts.push(`${nNew} new row${nNew>1?'s':''} added in the sheet`);
  if (nMod)  parts.push(`${nMod} row${nMod>1?'s':''} edited in the sheet`);
  title.textContent = 'Changes detected in Google Sheet';
  sub.textContent   = parts.join(' ¬∑ ');
  banner.classList.add('visible');
}

function hideSyncBanner() {
  const banner = document.getElementById('syncBanner');
  banner.classList.remove('visible');
}

function dismissSyncBanner() {
  pendingSheetChanges = [];
  hideSyncBanner();
}

// ‚îÄ‚îÄ‚îÄ APPLY PULLED CHANGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function applySheetChanges() {
  if (!pendingSheetChanges || (!pendingSheetChanges.newRows?.length && !pendingSheetChanges.modifiedRows?.length)) {
    hideSyncBanner();
    return;
  }
  hideSyncBanner();

  const { newRows, modifiedRows } = pendingSheetChanges;
  pendingSheetChanges = [];

  let imported = 0, updated = 0, skipped = 0;

  // 1. Import brand-new rows (added directly in sheet)
  for (const { row, sh } of newRows) {
    const newEntry = rowToEntry(row, sh);
    // Assign a local ID if the row doesn't have one, and write it back to sheet
    if (!newEntry.id) {
      newEntry.id = Date.now() + Math.floor(Math.random() * 9999);
      try {
        const idRes = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: sh.sheetId, range: `${sh.tab||'Sheet1'}!A:B`
        });
        const shRows = idRes.result.values || [];
        const rowIdx = shRows.findIndex((r, i) => i > 0 && r[0] === newEntry.date && r[1] === newEntry.title);
        if (rowIdx > 0) {
          await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: sh.sheetId,
            range: `${sh.tab||'Sheet1'}!I${rowIdx + 1}`,
            valueInputOption: 'RAW',
            resource: { values: [[String(newEntry.id)]] }
          });
        }
      } catch(e) {}
    }
    entries.unshift(newEntry);
    imported++;
  }

  // 2. Handle modified rows (sheet version is newer/different)
  const autoKeepSheet  = cfg.syncConflict === 'sheet';
  const autoKeepLocal  = cfg.syncConflict === 'local';
  const shouldAsk      = cfg.syncConflict === 'ask';
  conflictQueue = []; // reset before building

  for (const { row, sh, localEntry } of modifiedRows) {
    if (autoKeepSheet) {
      // Overwrite local entry with sheet data, preserve local id
      const sheetData = rowToEntry(row, sh);
      const idx = entries.findIndex(e => e.id === localEntry.id);
      if (idx !== -1) {
        entries[idx] = {
          ...sheetData,         // new sheet fields first
          id: localEntry.id,    // always keep local numeric id
          sheetId: localEntry.sheetId,
          sheetName: localEntry.sheetName,
          synced: true,
          fromSheet: true
        };
      }
      updated++;
    } else if (autoKeepLocal) {
      skipped++;
    } else if (shouldAsk) {
      conflictQueue.push({ row, sh, localEntry });
    }
  }

  // Always save & render what we have so far (new imports are visible immediately)
  save();
  updateLogBar();
  renderHistory();

  // Show what happened
  const parts = [];
  if (imported) parts.push(`${imported} new`);
  if (updated)  parts.push(`${updated} updated`);
  if (skipped)  parts.push(`${skipped} skipped`);
  if (parts.length) toast(`‚Üì Sheet sync: ${parts.join(', ')} entr${(imported + updated) > 1 ? 'ies' : 'y'}`, 'ok');

  // If there are conflicts to ask about, start the queue AFTER render
  if (conflictQueue.length) processNextConflict();
}

// ‚îÄ‚îÄ‚îÄ CONFLICT RESOLUTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function processNextConflict() {
  if (!conflictQueue.length) {
    // All resolved
    updateLogBar(); renderHistory();
    return;
  }
  currentConflict = conflictQueue.shift();
  const { row, sh, localEntry } = currentConflict;
  const sheetEntry = rowToEntry(row, sh);

  const compare = document.getElementById('conflictCompare');
  compare.innerHTML = `
    <div class="conflict-side local">
      <div class="conflict-label l">üì± Local (App)</div>
      <div class="conflict-field">Title</div><div class="conflict-val">${localEntry.title}</div>
      <div class="conflict-field" style="margin-top:6px">Desc</div><div class="conflict-val">${localEntry.desc||'‚Äî'}</div>
      <div class="conflict-field" style="margin-top:6px">Impact / Effort</div><div class="conflict-val">${localEntry.impact||'medium'} ¬∑ ${localEntry.effort||'?'}h</div>
      <div class="conflict-field" style="margin-top:6px">Categories</div><div class="conflict-val">${(localEntry.cats||[]).join(', ')||'‚Äî'}</div>
    </div>
    <div class="conflict-side remote">
      <div class="conflict-label r">üìä Sheet (Remote)</div>
      <div class="conflict-field">Title</div><div class="conflict-val">${sheetEntry.title}</div>
      <div class="conflict-field" style="margin-top:6px">Desc</div><div class="conflict-val">${sheetEntry.desc||'‚Äî'}</div>
      <div class="conflict-field" style="margin-top:6px">Impact / Effort</div><div class="conflict-val">${sheetEntry.impact||'medium'} ¬∑ ${sheetEntry.effort||'?'}h</div>
      <div class="conflict-field" style="margin-top:6px">Categories</div><div class="conflict-val">${(sheetEntry.cats||[]).join(', ')||'‚Äî'}</div>
    </div>`;

  document.getElementById('conflictModal').classList.add('open');
}

function resolveConflict(choice) {
  document.getElementById('conflictModal').classList.remove('open');
  if (!currentConflict) { processNextConflict(); return; }
  const { row, sh, localEntry } = currentConflict;

  if (choice === 'sheet') {
    const sheetData = rowToEntry(row, sh);
    const idx = entries.findIndex(e => e.id === localEntry.id);
    if (idx !== -1) {
      entries[idx] = {
        ...sheetData,
        id: localEntry.id,
        sheetId: localEntry.sheetId,
        sheetName: localEntry.sheetName,
        synced: true,
        fromSheet: true
      };
    }
    save(); renderHistory();
    toast('Sheet version applied ‚úì', 'ok');
  } else if (choice === 'local') {
    toast('Local version kept', 'ok');
  } else {
    toast('Skipped ‚Äî will ask again next sync', '');
  }

  currentConflict = null;
  setTimeout(processNextConflict, 300);
}

// ‚îÄ‚îÄ‚îÄ GAPI (Google Identity Services) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tokenClient = null;
let accessToken = null;

function loadGapi() {
  if (!cfg.clientId) return;
  if (!window.gapi) {
    const sc = document.createElement('script');
    sc.src = 'https://apis.google.com/js/api.js';
    sc.onload = () => gapi.load('client', initGapiClient);
    sc.onerror = () => toast('Failed to load Google API','err');
    document.head.appendChild(sc);
  } else {
    gapi.load('client', initGapiClient);
  }
  if (!window.google?.accounts) {
    const sc2 = document.createElement('script');
    sc2.src = 'https://accounts.google.com/gsi/client';
    sc2.onload = initTokenClient;
    sc2.onerror = () => toast('Failed to load Google Identity Services','err');
    document.head.appendChild(sc2);
  } else {
    initTokenClient();
  }
}

async function initGapiClient() {
  try {
    await gapi.client.init({});
    await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4');
    gapiReady = true;
    if (accessToken) gapi.client.setToken({ access_token: accessToken });
  } catch(e) { toast('Failed to init Google Sheets client','err'); }
}

function initTokenClient() {
  if (!cfg.clientId) return;
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: cfg.clientId,
    scope: 'https://www.googleapis.com/auth/spreadsheets',
    callback: (tokenResponse) => {
      if (tokenResponse.error) {
        toast('Google Auth error ‚Äî check Client ID & authorized origins','err');
        document.getElementById('authStatus').textContent = '‚úï Auth failed';
        return;
      }
      accessToken = tokenResponse.access_token;
      if (gapiReady) gapi.client.setToken({ access_token: accessToken });
      onSignIn(true);
    },
  });
  tokenClient.requestAccessToken({ prompt: '' });
}

function onSignIn(ok) {
  signedIn = ok;
  if (ok) {
    const status = document.getElementById('authStatus');
    if (status) status.textContent = '‚úì Connected';
    cfg.sheets.forEach(s => ensureHeaders(s));
    syncAllPending();
    // Start polling if enabled
    if (cfg.autoSync) startPolling();
    // Show pull button
    const histPullBtn = document.getElementById('histPullBtn');
    if (histPullBtn) histPullBtn.style.display = '';
  }
  renderSwitcher(); updateLogBar();
}

async function ensureHeaders(sh) {
  if (!signedIn || !sh?.sheetId) return;
  try {
    const r = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: sh.sheetId, range: `${sh.tab||'Sheet1'}!A1` });
    if (!r.result.values || r.result.values[0][0] !== 'Date') {
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: sh.sheetId, range: `${sh.tab||'Sheet1'}!A1`, valueInputOption: 'RAW',
        resource: { values: [['Date','Title','Description','Categories','Impact','Outcome','Effort (hrs)','Month','ID','Created','Sheet Name']] }
      });
    }
  } catch(e) {}
}

async function pushEntry(entry) {
  if (!signedIn) return false;
  const sh = sheetById(entry.sheetId);
  if (!sh?.sheetId) return false;
  try {
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: sh.sheetId, range: `${sh.tab||'Sheet1'}!A:K`,
      valueInputOption: 'RAW', insertDataOption: 'INSERT_ROWS',
      resource: { values: [[ entry.date, entry.title, entry.desc||'', (entry.cats||[]).join(', '),
        entry.impact||'', entry.outcome||'', entry.effort||'',
        entry.month, String(entry.id), entry.created||'', sh.name ]] }
    });
    return true;
  } catch(e) { return false; }
}

async function updateEntryInSheet(entry) {
  if (!signedIn || !entry?.sheetId) return false;
  const sh = sheetById(entry.sheetId);
  if (!sh?.sheetId) return false;
  try {
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: sh.sheetId, range: `${sh.tab||'Sheet1'}!I:I`
    });
    const rows = res.result.values || [];
    const rowIndex = rows.findIndex(r => r[0] === String(entry.id));
    if (rowIndex === -1) return await pushEntry(entry);
    const rowNum = rowIndex + 1;
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: sh.sheetId,
      range: `${sh.tab||'Sheet1'}!A${rowNum}:K${rowNum}`,
      valueInputOption: 'RAW',
      resource: { values: [[ entry.date, entry.title, entry.desc||'', (entry.cats||[]).join(', '),
        entry.impact||'', entry.outcome||'', entry.effort||'',
        entry.month, String(entry.id), entry.created||'', sh.name ]] }
    });
    return true;
  } catch(e) { return false; }
}

async function syncAllPending() {
  const pending = entries.filter(e => !e.synced && e.sheetId);
  if (!pending.length) return;
  let n = 0;
  for (const e of pending) { const ok = await pushEntry(e); if (ok) { e.synced = true; n++; } }
  if (n) { save(); updateLogBar(); if (document.getElementById('panel-history').classList.contains('active')) renderHistory(); }
}

// ‚îÄ‚îÄ‚îÄ ADD ENTRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addEntry() {
  const date  = document.getElementById('fDate').value;
  const title = document.getElementById('fTitle').value.trim();
  if (!date||!title) { toast('Date and title required','err'); return; }
  const as = activeSheet();
  const entry = {
    id: Date.now(), date, title,
    desc:    document.getElementById('fDesc').value.trim(),
    cats:    getSelCats('logCats'),
    impact:  document.getElementById('fImpact').value,
    outcome: document.getElementById('fOutcome').value.trim(),
    effort:  document.getElementById('fEffort').value,
    month: date.slice(0,7), synced: false, created: new Date().toISOString(),
    sheetId: as?.id||null, sheetName: as?.name||null
  };
  entries.unshift(entry); save();
  document.getElementById('saveHint').textContent = 'Saving‚Ä¶';
  const ok = await pushEntry(entry);
  entry.synced = ok; save(); updateLogBar();
  document.getElementById('saveHint').textContent = ok ? '‚úì Synced' : '‚óã Saved locally';
  setTimeout(() => document.getElementById('saveHint').textContent = '', 3000);
  clearForm();
  toast(ok ? '‚úÖ Entry saved & synced!' : '‚úÖ Saved locally', 'ok');
}

function clearForm() {
  ['fTitle','fDesc','fOutcome','fEffort'].forEach(id => document.getElementById(id).value='');
  document.getElementById('fImpact').value = 'medium';
  document.getElementById('fDate').value = new Date().toISOString().split('T')[0];
  setSelCats('logCats',[]);
}

async function deleteEntry(id) {
  if (!confirm('Delete this entry?')) return;
  const entry = entries.find(e => e.id === id);
  entries = entries.filter(e => e.id !== id);
  save(); updateLogBar(); renderHistory(); toast('Entry deleted');
  if (signedIn && entry?.synced && entry?.sheetId) {
    const sh = sheetById(entry.sheetId);
    if (!sh?.sheetId) return;
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: sh.sheetId, range: `${sh.tab||'Sheet1'}!I:I`
      });
      const rows = res.result.values || [];
      const rowIndex = rows.findIndex(r => r[0] === String(entry.id));
      if (rowIndex === -1) return;
      const meta = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: sh.sheetId });
      const sheetMeta = meta.result.sheets.find(s => s.properties.title === (sh.tab||'Sheet1'));
      if (!sheetMeta) return;
      const numericSheetId = sheetMeta.properties.sheetId;
      await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: sh.sheetId,
        resource: { requests: [{ deleteDimension: { range: { sheetId: numericSheetId, dimension: 'ROWS', startIndex: rowIndex, endIndex: rowIndex+1 } } }] }
      });
      toast('Deleted from Google Sheet ‚úì', 'ok');
    } catch(e) { toast('Local deleted ‚Äî Sheet row removal failed', 'err'); }
  }
}

// ‚îÄ‚îÄ‚îÄ EDIT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEdit(id) {
  const e = entries.find(e=>e.id===id); if (!e) return;
  editingId = id;
  document.getElementById('mDate').value    = e.date;
  document.getElementById('mTitle').value   = e.title;
  document.getElementById('mDesc').value    = e.desc||'';
  document.getElementById('mImpact').value  = e.impact||'medium';
  document.getElementById('mOutcome').value = e.outcome||'';
  document.getElementById('mEffort').value  = e.effort||'';
  setSelCats('modalCats', e.cats||[]);
  document.getElementById('editModal').classList.add('open');
}
async function saveEdit() {
  const e = entries.find(e=>e.id===editingId); if (!e) return;
  e.date    = document.getElementById('mDate').value;
  e.title   = document.getElementById('mTitle').value.trim();
  e.desc    = document.getElementById('mDesc').value.trim();
  e.cats    = getSelCats('modalCats');
  e.impact  = document.getElementById('mImpact').value;
  e.outcome = document.getElementById('mOutcome').value.trim();
  e.effort  = document.getElementById('mEffort').value;
  e.month   = e.date.slice(0,7);
  e.synced  = false;
  save(); closeEditModal(); renderHistory(); toast('Updated','ok');
  const ok = await updateEntryInSheet(e);
  if (ok) { e.synced=true; save(); renderHistory(); toast('Synced to Sheet ‚úì','ok'); }
  else if (!signedIn) { toast('Saved locally ‚Äî will sync later','ok'); }
}
function closeEditModal() { document.getElementById('editModal').classList.remove('open'); editingId=null; }
function closeBgEdit(e)   { if (e.target===document.getElementById('editModal')) closeEditModal(); }

// ‚îÄ‚îÄ‚îÄ MANAGE SHEETS MODAL (continued) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pickColor(el) {
  document.querySelectorAll('.swatch').forEach(s => s.classList.remove('sel'));
  el.classList.add('sel'); newColor = el.dataset.color;
}

function addNewSheet() {
  const name    = document.getElementById('nsName').value.trim();
  const sheetId = document.getElementById('nsSheetId').value.trim();
  if (!name)    { toast('Enter a sheet name','err'); return; }
  if (!sheetId) { toast('Enter a Google Sheet ID','err'); return; }
  const sheet = { id: uid(), name, sheetId, color: newColor, tab: 'Sheet1' };
  cfg.sheets.push(sheet);
  if (!cfg.activeSheetId) cfg.activeSheetId = sheet.id;
  saveCfg();
  document.getElementById('nsName').value = '';
  document.getElementById('nsSheetId').value = '';
  renderSheetList(); renderSwitcher(); renderDropdowns(); updateLogBar();
  if (signedIn) ensureHeaders(sheet);
  toast(`"${name}" connected!`, 'ok');
}

function removeSheet(id) {
  const s = sheetById(id); if (!s) return;
  const n = entries.filter(e=>e.sheetId===id).length;
  if (!confirm(`Remove sheet "${s.name}"?\n\n${n>0?n+' entries will keep their local data but won\'t sync.\n\n':''}The Google Sheet itself will NOT be deleted.`)) return;
  cfg.sheets = cfg.sheets.filter(sh => sh.id !== id);
  if (cfg.activeSheetId === id) cfg.activeSheetId = cfg.sheets[0]?.id || null;
  saveCfg();
  renderSheetList(); renderSwitcher(); renderDropdowns(); updateLogBar();
  toast(`"${s.name}" removed`);
}

function saveClientId() {
  const cid = document.getElementById('cfgClientId').value.trim();
  if (!cid) { toast('Enter your Client ID','err'); return; }
  cfg.clientId = cid; saveCfg();
  document.getElementById('authStatus').textContent = 'Connecting‚Ä¶';
  tokenClient = null; accessToken = null; gapiReady = false; signedIn = false;
  loadGapi();
}

// ‚îÄ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHistory() {
  const fm  = document.getElementById('fMonth').value;
  const fsh = document.getElementById('fSheetH').value;
  const fc  = document.getElementById('fCat').value;
  const fi  = document.getElementById('fImpH').value;
  let list = [...entries];
  if (fm)  list = list.filter(e=>e.month===fm);
  if (fsh) list = list.filter(e=>e.sheetId===fsh);
  if (fc)  list = list.filter(e=>(e.cats||[]).includes(fc));
  if (fi)  list = list.filter(e=>e.impact===fi);

  document.getElementById('histCount').textContent = list.length+' entries';
  document.getElementById('syncBtn').style.display = (list.some(e=>!e.synced) && cfg.sheets.length) ? '':'none';
  const histPullBtn = document.getElementById('histPullBtn');
  if (histPullBtn) histPullBtn.style.display = signedIn && cfg.sheets.length ? '' : 'none';

  const el = document.getElementById('histList');
  if (!list.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">üìì</div><h3>No entries found</h3><p>Try changing filters or log some tasks.</p></div>`;
    return;
  }
  const groups = {};
  list.forEach(e => { if (!groups[e.date]) groups[e.date]=[]; groups[e.date].push(e); });
  el.innerHTML = Object.keys(groups).sort((a,b)=>b.localeCompare(a)).map(date => {
    const de = groups[date];
    const dayCats = [...new Set(de.flatMap(e=>e.cats||[]))];
    const dayHrs  = de.reduce((s,e)=>s+(parseFloat(e.effort)||0),0);
    const dow = new Date(date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long'});
    const dtLbl = new Date(date+'T12:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
    const mainCat = e => {
      const c=e.cats||[];
      if(c.includes('dev')&&c.includes('pm')) return 't-both';
      if(c.includes('dev')) return 't-dev';
      if(c.includes('pm'))  return 't-pm';
      if(c.includes('learn')) return 't-learn';
      return '';
    };
    return `
<div class="day-group">
  <div class="day-header">
    <div><div class="day-date-label">${dtLbl}</div><div class="day-dow">${dow}</div></div>
    <div class="day-cat-pills">${dayCats.map(c=>`<span class="day-pill pill-${c}">${c}</span>`).join('')}</div>
    ${dayHrs>0?`<div class="day-hrs">${dayHrs.toFixed(1)}h</div>`:''}
  </div>
  ${de.map(e => {
    const sh = sheetById(e.sheetId);
    const impCls = e.impact==='high'?'chip-hi':e.impact==='medium'?'chip-med':'chip-lo';
    const sheetChip = sh ? `<span class="chip" style="background:${sh.color}18;color:${sh.color};border:1px solid ${sh.color}40">${sh.name}</span>` : '';
    const fromSheetChip = e.fromSheet ? `<span class="chip chip-sheet-src">from sheet</span>` : '';
    const syncDotCls = e.fromSheet ? 'sheet' : (e.synced ? 'ok' : 'pend');
    const syncDotTitle = e.fromSheet ? 'Imported from Sheet' : (e.synced ? 'Synced' : 'Pending sync');
    return `
<div class="entry ${mainCat(e)}${e.fromSheet?' t-sheet-modified':''}">
  <div class="entry-row">
    <div style="flex:1;min-width:0">
      <div class="entry-title">${e.title}</div>
      ${e.desc?`<div class="entry-desc">${e.desc}</div>`:''}
      <div class="entry-chips">
        ${(e.cats||[]).map(c=>`<span class="chip chip-${['dev','pm','learn'].includes(c)?c:'other'}">${c}</span>`).join('')}
        <span class="chip ${impCls}">${e.impact||'medium'}</span>
        ${e.effort?`<span class="chip chip-other">${e.effort}h</span>`:''}
        ${sheetChip}
        ${fromSheetChip}
        <span class="sync-dot ${syncDotCls}" title="${syncDotTitle}"></span>
      </div>
      ${e.outcome?`<div class="entry-outcome">${e.outcome}</div>`:''}
    </div>
    <div class="entry-actions">
      <button class="btn btn-edit" onclick="openEdit(${e.id})">‚úé</button>
      <button class="btn btn-danger btn-sm" onclick="deleteEntry(${e.id})">‚úï</button>
    </div>
  </div>
</div>`;}).join('')}
</div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateReport() {
  const month = document.getElementById('rMonth').value;
  const fsh   = document.getElementById('fSheetR').value;
  if (!month) { toast('Select a month','err'); return; }
  let me = entries.filter(e=>e.month===month);
  if (fsh) me = me.filter(e=>e.sheetId===fsh);

  const out = document.getElementById('reportOut');
  if (!me.length) {
    out.innerHTML = `<div class="empty"><div class="empty-icon">üìä</div><h3>No entries for this period</h3><p>Log tasks first then generate your report.</p></div>`;
    return;
  }
  out.innerHTML = `<div class="loading-wrap"><div class="spin"></div><div class="loading-txt">Analysing all entries with AI ‚Äî this may take a moment</div></div>`;

  // ‚îÄ‚îÄ Build rich stats for the prompt ‚îÄ‚îÄ
  const totalHrs    = me.reduce((s,e)=>s+(parseFloat(e.effort)||0),0);
  const daysActive  = [...new Set(me.map(e=>e.date))].length;
  const highCount   = me.filter(e=>e.impact==='high').length;
  const medCount    = me.filter(e=>e.impact==='medium').length;
  const lowCount    = me.filter(e=>e.impact==='low').length;
  const catCounts   = {};
  me.forEach(e=>(e.cats||[]).forEach(c=>{ catCounts[c]=(catCounts[c]||0)+1; }));
  const catSummary  = Object.entries(catCounts).sort((a,b)=>b[1]-a[1]).map(([c,n])=>`${c}:${n}`).join(', ');
  const withOutcome = me.filter(e=>e.outcome).length;
  const withDesc    = me.filter(e=>e.desc && e.desc.length>20).length;
  const avgEffort   = me.filter(e=>e.effort).length ? (totalHrs / me.filter(e=>e.effort).length).toFixed(1) : '?';

  // Week-by-week breakdown
  const byWeek = {};
  me.forEach(e=>{
    const d = new Date(e.date+'T12:00');
    const wk = `W${Math.ceil(d.getDate()/7)}`;
    if(!byWeek[wk]) byWeek[wk]=[];
    byWeek[wk].push(e);
  });
  const weekSummary = Object.entries(byWeek).map(([w,es])=>`${w}: ${es.length} tasks, ${es.reduce((s,e)=>s+(parseFloat(e.effort)||0),0).toFixed(1)}h`).join(' | ');

  // High-impact entries for deep analysis
  const highlights = me.filter(e=>e.impact==='high' || e.outcome).slice(0,12)
    .map(e=>`  [${e.date}] "${e.title}" (${(e.cats||[]).join('+')||'uncategorised'}, ${e.effort||'?'}h) ‚Üí ${e.outcome||'no outcome noted'} | ${e.desc||'no description'}`).join('\n');

  // All entries compact
  const allLog = me.sort((a,b)=>a.date.localeCompare(b.date))
    .map(e=>`[${e.date}] [${e.impact}] [${(e.cats||[]).join('+')||'?'}] ${e.title} (${e.effort||'?'}h) | outcome: ${e.outcome||'‚Äî'} | notes: ${e.desc||'‚Äî'}`).join('\n');

  const prompt = `You are a senior engineering manager AND product lead conducting a deep monthly performance review.
Analyse this developer's complete work log for ${month} and produce a thorough, honest, specific report.

== STATISTICS ==
Total entries: ${me.length} | Active days: ${daysActive} | Total hours logged: ${totalHrs.toFixed(1)}h | Avg effort/task: ${avgEffort}h
Impact split: ${highCount} high / ${medCount} medium / ${lowCount} low
Category breakdown: ${catSummary}
Entries with outcomes: ${withOutcome}/${me.length} | Entries with detail: ${withDesc}/${me.length}
Week-by-week: ${weekSummary}

== HIGH-IMPACT & OUTCOME ENTRIES (analyse these deeply) ==
${highlights || 'None tagged as high impact'}

== COMPLETE LOG ==
${allLog}

Respond with ONLY valid JSON (absolutely no markdown, no explanation, no code blocks):
{
  "devGrade": "A/B/C/D",
  "pmGrade": "A/B/C/D",
  "overallGrade": "A/B/C/D",
  "consistencyGrade": "A/B/C/D",
  "devGradeReason": "One specific sentence citing actual tasks from the log",
  "pmGradeReason": "One specific sentence citing actual tasks from the log",
  "executiveSummary": "3-4 sentences: what was accomplished this month, what stands out, overall trajectory. Be specific ‚Äî name actual projects/tasks.",
  "deepAnalysis": "4-6 sentences of deep analysis: patterns in the work, quality of outcomes, how dev and PM skills interplay, any concerning gaps, growth trajectory. Reference specific entries.",
  "oneThingToRemember": "One powerful, memorable insight personalised to THIS person's actual work this month",
  "devStrengths": ["Specific strength with example from log","Specific strength with example","Specific strength with example"],
  "devImprove": ["Specific actionable improvement with context","Specific improvement","Specific improvement"],
  "pmStrengths": ["Specific PM strength observed","Specific PM strength","Specific PM strength"],
  "pmImprove": ["Specific PM improvement needed","Specific improvement","Specific improvement"],
  "topLearnings": ["Key learning extracted from outcomes/notes","Key learning","Key learning"],
  "blindSpots": ["A pattern or area being neglected based on log analysis","Another blind spot"],
  "weeklyRhythm": "2-3 sentences analysing consistency across weeks ‚Äî were there productive sprints, dead weeks, clustering of work?",
  "impactAnalysis": "2-3 sentences on whether the high-impact tasks represent real milestones or whether high-impact is being over- or under-used as a tag",
  "careerInsight": "2-3 sentences: what does this month's work say about their career trajectory, skills development, and professional brand?",
  "nextMonthGoals": ["Specific, actionable goal tied to identified gap","Specific goal","Specific goal"],
  "keyMetrics": {
    "focusScore": "0-100 integer (how focused vs scattered was the work)",
    "depthScore": "0-100 integer (how deep vs shallow based on effort and descriptions)",
    "outcomeScore": "0-100 integer (% of tasks with meaningful outcomes)",
    "consistencyScore": "0-100 integer (regularity of work across the month)"
  }
}`;

  let r;
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ model:'claude-sonnet-4-20250514', max_tokens:2500, messages:[{role:'user',content:prompt}] })
    });
    const data = await res.json();
    const raw = (data.content||[]).map(c=>c.text||'').join('').replace(/```json|```/g,'').trim();
    r = JSON.parse(raw);
  } catch(e) { r = fallbackReport(me); }

  currentReport = r;
  currentReportMonth = month + (fsh ? '::'+fsh : '');
  currentRating = (reflections[currentReportMonth]||{}).rating||0;
  renderReport(r, me, month, fsh);
  ['saveReflBtn','exportRptBtn','deleteRptBtn'].forEach(id => document.getElementById(id).style.display='');
}

function fallbackReport(me) {
  const dN=me.filter(e=>(e.cats||[]).includes('dev')).length;
  const pN=me.filter(e=>(e.cats||[]).includes('pm')).length;
  const g=n=>n>=15?'A':n>=8?'B':n>=4?'C':'D';
  const hrs = me.reduce((s,e)=>s+(parseFloat(e.effort)||0),0);
  return {
    devGrade:g(dN), pmGrade:g(pN), overallGrade:g(me.length), consistencyGrade:'B',
    devGradeReason:`${dN} dev tasks logged across the month.`,
    pmGradeReason:`${pN} PM-related tasks logged.`,
    executiveSummary:`You logged ${me.length} entries totalling ${hrs.toFixed(1)} hours this period. The AI analysis requires an Anthropic API key ‚Äî add it to get deep personalised insights.`,
    deepAnalysis:'Connect to the Anthropic API for a deep analysis of your work patterns, quality, and growth trajectory.',
    oneThingToRemember:'The more detail you log, the more insight you get back.',
    devStrengths:['Active development logging','Tracking task outcomes','Cross-category work visibility'],
    devImprove:['Add more technical detail to entries','Track deep work vs meetings separately','Document key decisions and their rationale'],
    pmStrengths:['Growing product awareness','Logging cross-functional collaboration','Building outcome-oriented thinking'],
    pmImprove:['Log more PM-specific tasks','Add user impact context to outcomes','Practice framing work in problem/solution terms'],
    topLearnings: me.filter(e=>e.outcome).slice(0,3).map(e=>e.outcome).filter(Boolean),
    blindSpots:['Under-representing PM work relative to dev','Missing effort estimates on many entries'],
    weeklyRhythm:'Add more entries for weekly pattern analysis.',
    impactAnalysis:'Tag more entries with impact levels to get meaningful impact distribution analysis.',
    careerInsight:'Log consistently for 2-3 months to see career trajectory patterns emerge.',
    nextMonthGoals:['Log at least 1 PM-focused task per week','Add effort hours to every single entry','Write a weekly retro entry every Friday'],
    keyMetrics:{ focusScore:50, depthScore:50, outcomeScore:Math.round((me.filter(e=>e.outcome).length/me.length)*100)||0, consistencyScore:50 }
  };
}

function renderReport(r, me, month, fsh) {
  const label = new Date(month+'-02').toLocaleString('default',{month:'long',year:'numeric'});
  const dN = me.filter(e=>(e.cats||[]).includes('dev')).length;
  const pN = me.filter(e=>(e.cats||[]).includes('pm')).length;
  const hN = me.filter(e=>e.impact==='high').length;
  const oN = me.filter(e=>e.outcome).length;
  const hrs = me.reduce((s,e)=>s+(parseFloat(e.effort)||0),0);
  const daysIn = new Date(month.split('-')[0],parseInt(month.split('-')[1]),0).getDate();
  const dayMap = {};
  me.forEach(e=>{
    const d=parseInt(e.date.split('-')[2]),c=e.cats||[];
    if(c.includes('dev')&&c.includes('pm')) dayMap[d]='both';
    else if(c.includes('dev')) dayMap[d]=dayMap[d]||'dev';
    else if(c.includes('pm'))  dayMap[d]=dayMap[d]||'pm';
    else if(c.includes('learn')) dayMap[d]=dayMap[d]||'learn';
    else dayMap[d]=dayMap[d]||'dev';
  });
  const dots = Array.from({length:daysIn},(_,i)=>{
    const t=dayMap[i+1];
    return `<div class="act-dot ${t?'a-'+t:'a-empty'}" data-tip="Day ${i+1}${t?' ‚Äî '+t:''}"></div>`;
  }).join('');
  const ins = (arr,col) => (arr||[]).map(s=>`<div class="ins-item"><div class="ins-dot" style="background:${col}"></div><div>${s}</div></div>`).join('');
  const ref = reflections[currentReportMonth]||{};
  const sh  = fsh ? sheetById(fsh) : null;
  const km  = r.keyMetrics || {};

  const scoreBar = (val, col) => {
    const v = parseInt(val)||0;
    return `<div style="display:flex;align-items:center;gap:8px;margin-top:5px">
      <div style="flex:1;background:var(--rule);border-radius:3px;height:7px;overflow:hidden">
        <div style="width:${v}%;background:${col};height:100%;border-radius:3px;transition:width 0.6s ease"></div>
      </div>
      <span style="font-family:DM Mono,monospace;font-size:11px;font-weight:600;color:${col};min-width:32px">${v}</span>
    </div>`;
  };

  document.getElementById('reportOut').innerHTML = `
<div class="report-card">
  <div class="rc-header">
    <div>
      <div class="rc-title">Monthly Report Card</div>
      <div class="rc-month">${label} ¬∑ ${sh?`<span style="color:${sh.color}">${sh.name}</span>`:'All Sheets'} ¬∑ ${me.length} entries</div>
    </div>
    <div class="rc-stamp">${r.overallGrade}</div>
  </div>

  <!-- GRADES -->
  <div class="grade-grid">
    <div class="grade-box"><div class="grade-letter grade-${r.devGrade}">${r.devGrade}</div><div class="grade-lbl">Dev Skills</div><div class="grade-sub">${r.devGradeReason}</div></div>
    <div class="grade-box"><div class="grade-letter grade-${r.pmGrade}">${r.pmGrade}</div><div class="grade-lbl">PM Thinking</div><div class="grade-sub">${r.pmGradeReason}</div></div>
    <div class="grade-box"><div class="grade-letter grade-${r.consistencyGrade}">${r.consistencyGrade}</div><div class="grade-lbl">Consistency</div><div class="grade-sub">${Object.keys(dayMap).length} active days</div></div>
    <div class="grade-box"><div class="grade-letter grade-${r.overallGrade}">${r.overallGrade}</div><div class="grade-lbl">Overall</div><div class="grade-sub">${hN} high-impact</div></div>
  </div>

  <!-- STATS -->
  <div class="stat-strip">
    <div class="stat-item"><div class="stat-num">${me.length}</div><div class="stat-lbl">Entries</div></div>
    <div class="stat-item" style="border-left-color:var(--dev)"><div class="stat-num">${dN}</div><div class="stat-lbl">Dev</div></div>
    <div class="stat-item" style="border-left-color:var(--pm)"><div class="stat-num">${pN}</div><div class="stat-lbl">PM</div></div>
    <div class="stat-item" style="border-left-color:var(--red)"><div class="stat-num">${hN}</div><div class="stat-lbl">High Impact</div></div>
    <div class="stat-item"><div class="stat-num">${oN}</div><div class="stat-lbl">Outcomes</div></div>
    <div class="stat-item" style="border-left-color:var(--gold)"><div class="stat-num">${hrs>0?hrs.toFixed(1):'‚Äî'}</div><div class="stat-lbl">Hours</div></div>
  </div>

  <!-- SCORE METERS -->
  ${km.focusScore !== undefined ? `
  <div class="ins-box" style="margin-bottom:20px">
    <div class="ins-box-title" style="margin-bottom:12px">üìê Quality Scores</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <div><div style="font-size:12px;font-weight:600">Focus</div><div style="font-size:11px;color:var(--muted);margin-bottom:2px">How focused vs scattered</div>${scoreBar(km.focusScore,'var(--dev)')}</div>
      <div><div style="font-size:12px;font-weight:600">Depth</div><div style="font-size:11px;color:var(--muted);margin-bottom:2px">Effort & detail quality</div>${scoreBar(km.depthScore,'var(--sync-pull)')}</div>
      <div><div style="font-size:12px;font-weight:600">Outcomes</div><div style="font-size:11px;color:var(--muted);margin-bottom:2px">Tasks with clear results</div>${scoreBar(km.outcomeScore,'var(--gold)')}</div>
      <div><div style="font-size:12px;font-weight:600">Consistency</div><div style="font-size:11px;color:var(--muted);margin-bottom:2px">Regularity across month</div>${scoreBar(km.consistencyScore,'var(--pm)')}</div>
    </div>
  </div>` : ''}

  <!-- EXECUTIVE SUMMARY -->
  <div class="summary-box">
    <div class="ins-box-title" style="color:var(--dev);margin-bottom:7px">‚ú® Executive Summary <span class="badge badge-ai" style="margin-left:4px">AI</span></div>
    <p style="font-size:14px;line-height:1.8">${r.executiveSummary}</p>
    ${r.oneThingToRemember?`<p style="margin-top:10px;font-size:13px;font-family:DM Mono,monospace;color:var(--dev);font-style:italic;border-top:1px solid rgba(26,77,62,0.15);padding-top:10px">"${r.oneThingToRemember}"</p>`:''}
  </div>

  <!-- DEEP ANALYSIS -->
  ${r.deepAnalysis ? `
  <div class="ins-box" style="margin-bottom:20px;border-color:rgba(21,101,192,0.25);background:var(--sync-pull-light)">
    <div class="ins-box-title" style="color:var(--sync-pull);margin-bottom:8px">üî¨ Deep Analysis</div>
    <p style="font-size:13px;line-height:1.8;color:var(--text)">${r.deepAnalysis}</p>
  </div>` : ''}

  <!-- ACTIVITY MAP -->
  <div style="margin-bottom:20px">
    <div class="ins-box-title" style="margin-bottom:9px">Activity Heatmap ‚Äî ${label}</div>
    <div class="act-dots">${dots}</div>
    <div style="display:flex;gap:14px;margin-top:6px;font-family:DM Mono,monospace;font-size:10px;color:var(--muted)">
      <span><span style="display:inline-block;width:10px;height:10px;background:var(--dev);opacity:.7;border-radius:2px;margin-right:4px"></span>Dev</span>
      <span><span style="display:inline-block;width:10px;height:10px;background:var(--pm);opacity:.7;border-radius:2px;margin-right:4px"></span>PM</span>
      <span><span style="display:inline-block;width:10px;height:10px;background:var(--gold);opacity:.7;border-radius:2px;margin-right:4px"></span>Learn</span>
    </div>
  </div>

  <!-- WEEKLY RHYTHM -->
  ${r.weeklyRhythm ? `
  <div class="ins-box" style="margin-bottom:20px">
    <div class="ins-box-title" style="margin-bottom:6px">üìÖ Weekly Rhythm</div>
    <p style="font-size:13px;line-height:1.75;color:var(--text)">${r.weeklyRhythm}</p>
  </div>` : ''}

  <!-- STRENGTHS & IMPROVEMENTS -->
  <div class="ins-grid">
    <div class="ins-box"><div class="ins-box-title">üñ• Dev ‚Äî Strengths</div>${ins(r.devStrengths,'var(--dev)')}</div>
    <div class="ins-box"><div class="ins-box-title">üñ• Dev ‚Äî Improve</div>${ins(r.devImprove,'var(--red)')}</div>
    <div class="ins-box"><div class="ins-box-title">üì¶ PM ‚Äî Strengths</div>${ins(r.pmStrengths,'var(--pm)')}</div>
    <div class="ins-box"><div class="ins-box-title">üì¶ PM ‚Äî Improve</div>${ins(r.pmImprove,'var(--red)')}</div>
    <div class="ins-box"><div class="ins-box-title">üìö Top Learnings</div>${ins(r.topLearnings,'var(--gold)')}</div>
    <div class="ins-box"><div class="ins-box-title">‚ö†Ô∏è Blind Spots</div>${ins(r.blindSpots,'var(--pm)')}</div>
  </div>

  <!-- IMPACT ANALYSIS -->
  ${r.impactAnalysis ? `
  <div class="ins-box" style="margin-top:14px">
    <div class="ins-box-title" style="margin-bottom:6px">üéØ Impact Analysis</div>
    <p style="font-size:13px;line-height:1.75">${r.impactAnalysis}</p>
  </div>` : ''}

  <!-- CAREER INSIGHT -->
  ${r.careerInsight ? `
  <div class="ins-box" style="margin-top:14px;border-color:rgba(200,151,58,0.35);background:var(--gold-light)">
    <div class="ins-box-title" style="color:var(--gold);margin-bottom:6px">üöÄ Career Insight</div>
    <p style="font-size:13px;line-height:1.75">${r.careerInsight}</p>
  </div>` : ''}

  <!-- NEXT MONTH GOALS -->
  <div class="ins-box" style="margin-top:14px">
    <div class="ins-box-title">üéØ Next Month Goals</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:10px">
      ${(r.nextMonthGoals||[]).map((g,i)=>`<div style="display:flex;gap:9px;align-items:flex-start;font-size:13px;line-height:1.6;padding:10px;background:var(--paper);border-radius:4px;border:1px solid var(--rule)"><span style="font-family:DM Mono,monospace;font-weight:700;color:var(--dev);min-width:22px;font-size:12px">0${i+1}</span><span>${g}</span></div>`).join('')}
    </div>
  </div>

  <hr class="rc-divider">

  <!-- SELF REFLECTIONS -->
  <div>
    <div style="font-family:Playfair Display,serif;font-size:19px;font-weight:800;margin-bottom:14px">Self Reflections <span class="badge badge-self" style="font-size:9px;vertical-align:middle">Your Words</span></div>
    <div class="manual-grid">
      <div class="field"><label>What am I most proud of?</label><textarea id="rfl_proud" placeholder="Be specific...">${ref.proud||''}</textarea></div>
      <div class="field"><label>Biggest challenge this month</label><textarea id="rfl_challenge" placeholder="Be honest...">${ref.challenge||''}</textarea></div>
      <div class="field"><label>As a developer, I must focus on‚Ä¶</label><textarea id="rfl_dev" placeholder="Skill, habit, tool...">${ref.dev||''}</textarea></div>
      <div class="field"><label>As a PM thinker, I need to‚Ä¶</label><textarea id="rfl_pm" placeholder="User thinking, prioritization...">${ref.pm||''}</textarea></div>
      <div class="field manual-full"><label>Note to myself for next month</label><textarea id="rfl_note" style="min-height:60px" placeholder="Anything to remember...">${ref.note||''}</textarea></div>
      <div class="field"><label>Satisfaction this month</label>
        <div class="star-row" id="starRow">${[1,2,3,4,5].map(n=>`<button class="star-btn ${(ref.rating||0)>=n?'on':''}" onclick="setStar(${n})">‚òÖ</button>`).join('')}</div>
      </div>
      <div class="field"><label>Would I share this report?</label>
        <select id="rfl_share">
          <option value="">Choose...</option>
          <option value="yes" ${ref.share==='yes'?'selected':''}>Yes ‚Äî I'm proud of it</option>
          <option value="maybe" ${ref.share==='maybe'?'selected':''}>Maybe ‚Äî if asked</option>
          <option value="no" ${ref.share==='no'?'selected':''}>Not yet ‚Äî still growing</option>
        </select>
      </div>
    </div>
  </div>
</div>`;
}

function setStar(n) { currentRating=n; document.querySelectorAll('.star-btn').forEach((b,i)=>b.classList.toggle('on',i<n)); }

function saveReflections() {
  const m=currentReportMonth; if(!m) return;
  reflections[m] = {
    proud:document.getElementById('rfl_proud')?.value||'',
    challenge:document.getElementById('rfl_challenge')?.value||'',
    dev:document.getElementById('rfl_dev')?.value||'',
    pm:document.getElementById('rfl_pm')?.value||'',
    note:document.getElementById('rfl_note')?.value||'',
    rating:currentRating,
    share:document.getElementById('rfl_share')?.value||'',
    saved:new Date().toISOString()
  };
  saveReflStore(); toast('Reflections saved!','ok');
}

async function exportPDF() {
  const m = currentReportMonth; const r = currentReport;
  if (!m || !r) { toast('Generate a report first','err'); return; }

  toast('Building PDF‚Ä¶', 'info');

  // Load jsPDF from CDN if not present
  if (!window.jspdf) {
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      s.onload = res; s.onerror = rej;
      document.head.appendChild(s);
    });
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const PW = 210, PH = 297;
  const ML = 18, MR = 18, MT = 18;
  const CW = PW - ML - MR;
  let y = MT;

  // ‚îÄ‚îÄ Colour palette ‚îÄ‚îÄ
  const C = {
    ink:    [14,14,20],
    dev:    [26,77,62],
    pm:     [92,26,0],
    gold:   [200,151,58],
    red:    [192,57,43],
    blue:   [21,101,192],
    paper:  [245,242,237],
    paper2: [237,233,225],
    rule:   [217,211,200],
    muted:  [122,112,101],
    white:  [255,255,255],
  };

  const mp = m.split('::')[0];
  const fsh = m.includes('::') ? m.split('::')[1] : '';
  const label = new Date(mp+'-02').toLocaleString('default',{month:'long',year:'numeric'});
  const ref = reflections[m] || {};
  const me = (() => {
    let l = entries.filter(e => e.month === mp);
    if (fsh) l = l.filter(e => e.sheetId === fsh);
    return l;
  })();

  const dN  = me.filter(e=>(e.cats||[]).includes('dev')).length;
  const pN  = me.filter(e=>(e.cats||[]).includes('pm')).length;
  const hN  = me.filter(e=>e.impact==='high').length;
  const oN  = me.filter(e=>e.outcome).length;
  const hrs = me.reduce((s,e)=>s+(parseFloat(e.effort)||0),0);
  const daysActive = [...new Set(me.map(e=>e.date))].length;
  const km = r.keyMetrics || {};

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function setFill(col) { doc.setFillColor(...col); }
  function setDraw(col) { doc.setDrawColor(...col); }
  function setTxt(col)  { doc.setTextColor(...col); }
  function setFont(style, size) {
    doc.setFont('helvetica', style);
    doc.setFontSize(size);
  }

  function drawPageBase() {
    // Warm parchment background - fills entire page
    setFill(C.paper);
    doc.rect(0, 0, PW, PH, 'F');
    // Slightly lighter writing area
    setFill([249, 246, 241]);
    doc.rect(ML + 12, 0, PW - ML - MR - 12, PH, 'F');
    // Horizontal ruled lines
    for (let i = 0, ly = 7; ly < PH; ly += 6.5, i++) {
      doc.setLineWidth(i % 4 === 0 ? 0.22 : 0.1);
      setDraw(i % 4 === 0 ? [190, 175, 155] : C.rule);
      doc.line(0, ly, PW, ly);
    }
    // Gold margin line (bold)
    doc.setLineWidth(0.6);
    setDraw(C.gold);
    doc.line(ML + 8, 0, ML + 8, PH);
    // Second thinner margin
    doc.setLineWidth(0.15);
    setDraw([220, 185, 105]);
    doc.line(ML + 11, 0, ML + 11, PH);
    doc.setLineWidth(0.2);
  }

  function newPage() {
    doc.addPage();
    drawPageBase();
    y = MT;
  }

  function checkPage(needed = 20) {
    if (y + needed > PH - 15) newPage();
  }

  function wrappedText(text, x, maxW, lineH, align='left') {
    const lines = doc.splitTextToSize(String(text||''), maxW);
    doc.text(lines, x, y, { align });
    y += lines.length * lineH;
    return lines.length;
  }

  function sectionHeader(title, col = C.ink) {
    checkPage(14);
    y += 3;
    setFill(col); doc.rect(ML, y-4, CW, 8, 'F');
    setTxt(C.white); setFont('bold', 9);
    doc.text(title.toUpperCase(), ML+3, y+0.5);
    setTxt(C.ink);
    y += 7;
  }

  function gradeBox(x, bw, grade, label2, sub, col) {
    const bh = 22;
    setFill([...col, ...[]]); doc.setFillColor(...col);
    doc.roundedRect(x, y, bw, bh, 2, 2, 'F');
    setTxt(C.white); setFont('bold', 18);
    doc.text(grade, x + bw/2, y + 12, { align:'center' });
    setFont('normal', 7); doc.setTextColor(255,255,255,160);
    doc.text(label2.toUpperCase(), x + bw/2, y + 17.5, { align:'center' });
    if (sub) {
      setFont('normal', 6); setTxt([255,255,255]);
      const lines = doc.splitTextToSize(sub, bw-4);
      doc.text(lines[0]||'', x + bw/2, y + 21, { align:'center' });
    }
    setTxt(C.ink);
  }

  function scoreBar(label3, val, col, bx, barW) {
    checkPage(12);
    setFont('normal', 8); setTxt(C.muted);
    doc.text(label3, bx, y);
    const v = Math.min(100, Math.max(0, parseInt(val)||0));
    const bh = 4; const fullW = barW - 35;
    // background
    setFill(C.paper2); doc.roundedRect(bx+30, y-3.5, fullW, bh, 1, 1, 'F');
    // fill
    doc.setFillColor(...col); doc.roundedRect(bx+30, y-3.5, fullW*(v/100), bh, 1, 1, 'F');
    setFont('bold', 8); setTxt(col);
    doc.text(String(v), bx+30+fullW+3, y);
    setTxt(C.ink);
    y += 8;
  }

  function bulletList(items, col, indent=2) {
    (items||[]).forEach(item => {
      checkPage(8);
      setFill(col); doc.circle(ML+indent+1.5, y-1.2, 1.2, 'F');
      setFont('normal', 9); setTxt(C.ink);
      const lines = doc.splitTextToSize(String(item||''), CW - indent - 6);
      doc.text(lines, ML+indent+5, y);
      y += lines.length * 5 + 1;
    });
  }

  function twoColBullets(leftItems, leftTitle, leftCol, rightItems, rightTitle, rightCol) {
    checkPage(30);
    const colW = (CW - 4) / 2;
    const startY = y;
    // Left
    setFont('bold', 8); setTxt(leftCol);
    doc.text(leftTitle, ML, y); y += 5;
    const leftStart = y;
    (leftItems||[]).forEach(item => {
      doc.setFillColor(...leftCol); doc.circle(ML+1.5, y-1.2, 1.2, 'F');
      setFont('normal', 8); setTxt(C.ink);
      const lines = doc.splitTextToSize(String(item||''), colW-8);
      doc.text(lines, ML+5, y);
      y += lines.length * 4.5 + 1;
    });
    const leftEndY = y;
    // Right (reset y to start)
    y = startY;
    const rx = ML + colW + 4;
    setFont('bold', 8); setTxt(rightCol);
    doc.text(rightTitle, rx, y); y += 5;
    (rightItems||[]).forEach(item => {
      doc.setFillColor(...rightCol); doc.circle(rx+1.5, y-1.2, 1.2, 'F');
      setFont('normal', 8); setTxt(C.ink);
      const lines = doc.splitTextToSize(String(item||''), colW-8);
      doc.text(lines, rx+5, y);
      y += lines.length * 4.5 + 1;
    });
    y = Math.max(leftEndY, y) + 3;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PAGE 1 ‚Äî COVER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Draw page 1 background (paper + ruled lines + margin)
  drawPageBase();

  // Dark header band
  setFill(C.ink); doc.rect(0, 0, PW, 55, 'F');

  // Title
  setTxt(C.white); setFont('bold', 28);
  doc.text('Footprint', ML+10, 22);
  setFont('normal', 11); setTxt(C.gold);
  doc.text('Monthly Report Card', ML+10, 31);
  setFont('normal', 9); setTxt([180,170,160]);
  doc.text(label, ML+10, 39);
  doc.text(`${me.length} entries  ¬∑  ${daysActive} active days  ¬∑  ${hrs.toFixed(1)} hrs`, ML+10, 46);

  // Overall grade stamp
  setFont('bold', 42); setTxt(C.dev);
  doc.text(r.overallGrade, PW-MR-8, 42, { align:'right' });
  setFont('normal', 8); setTxt(C.gold);
  doc.text('OVERALL', PW-MR-8, 50, { align:'right' });

  y = 65;

  // Grade boxes
  const gw = (CW-9) / 4;
  const gradeColors = { A:C.dev, B:C.blue, C:C.gold, D:C.red };
  gradeBox(ML,        gw, r.devGrade,         'Dev Skills',   r.devGradeReason,   gradeColors[r.devGrade]||C.muted);
  gradeBox(ML+gw+3,   gw, r.pmGrade,          'PM Thinking',  r.pmGradeReason,    gradeColors[r.pmGrade]||C.muted);
  gradeBox(ML+2*gw+6, gw, r.consistencyGrade, 'Consistency',  `${daysActive} days`, gradeColors[r.consistencyGrade]||C.muted);
  gradeBox(ML+3*gw+9, gw, r.overallGrade,     'Overall',      `${hN} high-impact`, gradeColors[r.overallGrade]||C.muted);
  y += 27;

  // Stats row
  const stats = [
    {n:String(me.length), l:'Entries',    col:C.ink},
    {n:String(dN),        l:'Dev',        col:C.dev},
    {n:String(pN),        l:'PM',         col:C.pm},
    {n:String(hN),        l:'High Impact',col:C.red},
    {n:String(oN),        l:'Outcomes',   col:C.muted},
    {n:hrs>0?hrs.toFixed(1):'‚Äî', l:'Hours', col:C.gold},
  ];
  const sw = CW / stats.length;
  stats.forEach((s,i) => {
    const sx = ML + i*sw;
    doc.setFillColor(...s.col); doc.rect(sx, y, 2.5, 12, 'F');
    setFont('bold', 14); setTxt(s.col);
    doc.text(s.n, sx+5, y+8);
    setFont('normal', 7); setTxt(C.muted);
    doc.text(s.l.toUpperCase(), sx+5, y+13);
  });
  y += 18;

  // Quality scores
  if (km.focusScore !== undefined) {
    setFont('bold', 9); setTxt(C.muted);
    doc.text('QUALITY SCORES', ML, y); y += 5;
    const hw = CW/2 - 3;
    const sy = y;
    scoreBar('Focus',       km.focusScore,       C.dev,  ML,       hw);
    scoreBar('Depth',       km.depthScore,        C.blue, ML,       hw);
    y = sy;
    scoreBar('Outcomes',    km.outcomeScore,      C.gold, ML+hw+6,  hw);
    scoreBar('Consistency', km.consistencyScore,  C.pm,   ML+hw+6,  hw);
    y += 3;
  }

  // Executive Summary
  sectionHeader('Executive Summary', C.dev);
  setFont('normal', 9); setTxt(C.ink);
  y += 1;
  wrappedText(r.executiveSummary, ML, CW, 5.5);
  y += 2;
  if (r.oneThingToRemember) {
    checkPage(14);
    setFill(C.dev); doc.roundedRect(ML, y, CW, 12, 2, 2, 'F');
    setFont('italic', 9); setTxt(C.white);
    const qlines = doc.splitTextToSize(`"${r.oneThingToRemember}"`, CW-8);
    doc.text(qlines, ML+4, y+4.5);
    y += Math.max(12, qlines.length*5) + 3;
  }
  setTxt(C.ink);

  // Deep Analysis
  if (r.deepAnalysis) {
    sectionHeader('Deep Analysis', C.blue);
    setFont('normal', 9); setTxt(C.ink);
    wrappedText(r.deepAnalysis, ML, CW, 5.5);
    y += 2;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PAGE 2 ‚Äî STRENGTHS & IMPROVEMENTS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  newPage();

  setFill(C.ink); doc.rect(0, 0, PW, 14, 'F');
  setTxt(C.white); setFont('bold', 11); doc.text('Strengths & Improvements', ML+10, 9.5);
  setFont('normal', 8); setTxt(C.gold); doc.text(label, PW-MR, 9.5, {align:'right'});
  y = 20;

  twoColBullets(r.devStrengths, 'üñ•  Dev ‚Äî Strengths', C.dev,   r.devImprove,  'üñ•  Dev ‚Äî Improve',  C.red);
  y += 4;
  twoColBullets(r.pmStrengths,  'üì¶ PM ‚Äî Strengths',  C.pm,    r.pmImprove,   'üì¶ PM ‚Äî Improve',   C.red);
  y += 4;
  twoColBullets(r.topLearnings, 'üìö Top Learnings',   C.gold,  r.blindSpots,  '‚ö†  Blind Spots',    C.pm);
  y += 4;

  // Weekly rhythm
  if (r.weeklyRhythm) {
    sectionHeader('Weekly Rhythm', C.muted);
    setFont('normal', 9); setTxt(C.ink);
    wrappedText(r.weeklyRhythm, ML, CW, 5.5); y += 2;
  }

  // Impact analysis
  if (r.impactAnalysis) {
    sectionHeader('Impact Analysis', C.red);
    setFont('normal', 9); setTxt(C.ink);
    wrappedText(r.impactAnalysis, ML, CW, 5.5); y += 2;
  }

  // Career insight
  if (r.careerInsight) {
    checkPage(30);
    setFill(C.gold); doc.roundedRect(ML, y, CW, 2, 0, 0, 'F');
    y += 5;
    sectionHeader('Career Insight', C.gold);
    setFont('normal', 9); setTxt(C.ink);
    wrappedText(r.careerInsight, ML, CW, 5.5); y += 2;
  }

  // Next month goals
  sectionHeader('Next Month Goals', C.dev);
  (r.nextMonthGoals||[]).forEach((g,i) => {
    checkPage(10);
    setFill(C.dev); doc.roundedRect(ML, y-4, 6, 6, 1, 1, 'F');
    setFont('bold', 8); setTxt(C.white);
    doc.text(`0${i+1}`, ML+3, y+0.2, {align:'center'});
    setFont('normal', 9); setTxt(C.ink);
    const lines = doc.splitTextToSize(String(g||''), CW-10);
    doc.text(lines, ML+9, y);
    y += lines.length * 5 + 3;
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PAGE 3 ‚Äî REFLECTIONS + ENTRY LOG
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  newPage();
  setFill(C.pm); doc.rect(0, 0, PW, 14, 'F');
  setTxt(C.white); setFont('bold', 11); doc.text('Self Reflections', ML+10, 9.5);
  setFont('normal', 8); setTxt([255,200,180]); doc.text(label, PW-MR, 9.5, {align:'right'});
  y = 20;

  const reflFields = [
    ['Most Proud Of',           ref.proud],
    ['Biggest Challenge',       ref.challenge],
    ['As a Developer, Focus On',ref.dev],
    ['As a PM Thinker, I Need To', ref.pm],
    ['Note to Myself',          ref.note],
  ];
  reflFields.forEach(([lbl, val]) => {
    if (!val) return;
    checkPage(16);
    setFont('bold', 8); setTxt(C.pm);
    doc.text(lbl.toUpperCase(), ML, y); y += 4;
    setFill(C.paper2); doc.roundedRect(ML, y, CW, 1, 0, 0, 'F');
    setFont('normal', 9); setTxt(C.ink);
    const lines = doc.splitTextToSize(val, CW-4);
    doc.text(lines, ML+2, y+4);
    y += lines.length * 5 + 5;
  });

  if (ref.rating) {
    checkPage(10);
    setFont('bold', 8); setTxt(C.pm); doc.text('SATISFACTION', ML, y); y += 5;
    setFont('normal', 14); setTxt(C.gold);
    doc.text('‚òÖ'.repeat(ref.rating) + '‚òÜ'.repeat(5-ref.rating), ML, y); y += 8;
  }

  // Entry log
  sectionHeader('Complete Entry Log', C.ink);
  setFont('bold', 7); setTxt(C.muted);
  doc.text('Date', ML, y);
  doc.text('Title', ML+18, y);
  doc.text('Category', ML+100, y);
  doc.text('Impact', ML+130, y);
  doc.text('Hrs', ML+150, y);
  y += 2;
  setDraw(C.rule); doc.setLineWidth(0.2);
  doc.line(ML, y, PW-MR, y); y += 4;

  const sorted = [...me].sort((a,b)=>a.date.localeCompare(b.date));
  sorted.forEach((e,i) => {
    checkPage(8);
    if (i % 2 === 0) { setFill([248,246,242]); doc.rect(ML, y-3, CW, 6, 'F'); }
    setFont('normal', 7.5); setTxt(C.muted);
    doc.text(e.date, ML, y);
    setTxt(C.ink);
    const titleLines = doc.splitTextToSize(e.title||'', 78);
    doc.text(titleLines[0], ML+18, y);
    const catStr = (e.cats||[]).join('+') || '‚Äî';
    setTxt(C.dev);
    doc.text(catStr.slice(0,18), ML+100, y);
    const impCol = e.impact==='high'?C.red : e.impact==='medium'?C.dev : C.muted;
    setTxt(impCol); doc.text(e.impact||'‚Äî', ML+130, y);
    setTxt(C.muted); doc.text(e.effort?String(e.effort):'‚Äî', ML+150, y);
    y += 6;
    if (e.outcome) {
      setFont('italic', 7); setTxt(C.dev);
      const olines = doc.splitTextToSize('‚Üí '+e.outcome, CW-20);
      doc.text(olines[0], ML+18, y);
      y += 5;
    }
  });

  // Footer on last page
  y = PH - 12;
  setDraw(C.rule); doc.line(ML, y, PW-MR, y);
  setFont('normal', 7.5); setTxt(C.muted);
  doc.text(`Generated by Footprint Growth Portal ¬∑ ${new Date().toLocaleDateString('en-IN')}`, ML, y+5);
  setTxt(C.gold);
  doc.text('footprint ¬∑ growth portal', PW-MR, y+5, {align:'right'});

  doc.save(`footprint-report-${mp}.pdf`);
  toast('PDF saved!', 'ok');
}

function deleteReport() {
  const m=currentReportMonth; if(!m) return;
  const label=new Date(m.split('::')[0]+'-02').toLocaleString('default',{month:'long',year:'numeric'});
  if(!confirm(`Delete the report & reflections for ${label}?\n\nTask entries will NOT be deleted.`)) return;
  delete reflections[m]; saveReflStore();
  currentReport=null; currentReportMonth=null; currentRating=0;
  document.getElementById('reportOut').innerHTML='';
  ['saveReflBtn','exportRptBtn','deleteRptBtn'].forEach(id=>document.getElementById(id).style.display='none');
  toast('Report deleted','ok');
}

// Update "last checked" label every 30s
setInterval(updateLastSyncLabel, 30000);
</script>
</body>
</html>
